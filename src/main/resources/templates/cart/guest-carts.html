<!DOCTYPE html>
<style>
    ul.space-y-4 > li {
        border-top: 1px solid #e5e7eb;
        padding-top: 1rem;
        margin-top: 1rem;
    }

    .max-w-lg {
        max-width: unset;
    }
</style>

<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>비회원 장바구니</title>
    <link rel="stylesheet" th:href="@{/css/output.css}">
</head>
<body class="bg-gray-100">
<div th:replace="~{layout/fragments/header :: headerFragment}"></div>

<main class="container mx-auto px-4 py-8">
    <section>
        <div class="mx-auto max-w-4xl bg-white rounded-2xl shadow p-8">
            <h1 class="text-xl font-bold text-center text-gray-900 mb-6">Ink3</h1>

            <div class="flex justify-between items-center mb-4">
                <label class="inline-flex items-center">
                    <input type="checkbox" id="selectAll" class="mr-2">
                    <span>전체 선택</span>
                </label>
                <div class="flex gap-2">
                    <button onclick="removeAll()" class="bg-ink-primary text-white px-3 py-1 rounded">전체 삭제</button>
                    <button onclick="removeSelected()" class="bg-ink-primary text-white px-3 py-1 rounded">선택 삭제
                    </button>
                </div>
            </div>

            <ul class="space-y-4" id="cart-list"></ul>

            <div class="mt-8 flex justify-end border-t border-gray-100 pt-8">
                <div class="w-screen max-w-lg space-y-4">
                    <dl class="space-y-0.5 text-ml text-gray-700">
                        <div class="flex justify-between items-center">
                            <dt class="text-left w-full">주문 금액</dt>
                            <dd class="text-right w-full" id="order-price">￦0</dd>
                        </div>

                        <div class="flex justify-between items-center">
                            <dt class="text-left w-full">기본 할인 금액</dt>
                            <dd class="text-right w-full" id="discount-price">-￦0</dd>
                        </div>

                        <div class="flex justify-between items-center">
                            <dt class="text-left w-full">쿠폰 할인 금액</dt>
                            <dd class="text-right w-full" id="coupon-discount">-￦0</dd>
                        </div>

                        <div class="flex justify-between items-center !text-base font-medium">
                            <dt class="text-left w-full">총 주문 금액</dt>
                            <dd class="text-right w-full" id="total-price">￦0</dd>
                        </div>
                    </dl>

                    <div class="flex justify-end">
                        <span class="inline-flex items-center justify-center rounded-full bg-indigo-100 px-2.5 py-0.5 text-indigo-700">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                 stroke="currentColor" class="-ms-1 me-1.5 size-4">
                              <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M16.5 6v.75m0 3v.75m0 3v.75m0 3V18m-9-5.25h5.25M7.5 15h3M3.375 5.25c-.621 0-1.125.504-1.125 1.125v3.026a2.999 2.999 0 010 5.198v3.026c0 .621.504 1.125 1.125 1.125h17.25c.621 0 1.125-.504 1.125-1.125v-3.026a2.999 2.999 0 010-5.198V6.375c0-.621-.504-1.125-1.125-1.125H3.375z"/>
                            </svg>
                            <p class="text-xs whitespace-nowrap">쿠폰 적용 완료</p>
                        </span>
                    </div>

                    <div class="flex justify-end">
                        <a href="#"
                           class="ink-btn-primary bg-gray-700 px-5 py-3 text-sm text-gray-100 transition hover:bg-gray-600">
                            주문하기
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </section>
</main>

<div th:replace="~{layout/fragments/footer :: footerFragment}"></div>

<script>
    let onDeleteConfirm = null;

    function showDeleteModal(callback) {
        onDeleteConfirm = callback;
        const deleteModal = document.getElementById("deleteModal");
        deleteModal.classList.remove("hidden");
        deleteModal.classList.add("flex");
    }

    document.addEventListener("DOMContentLoaded", () => {
        const cancelBtn = document.getElementById("cancelBtn");
        const confirmBtn = document.getElementById("confirmBtn");

        cancelBtn.onclick = () => {
            const deleteModal = document.getElementById("deleteModal");
            deleteModal.classList.add("hidden");
            deleteModal.classList.remove("flex");
            onDeleteConfirm = null;
        };

        confirmBtn.onclick = () => {
            const deleteModal = document.getElementById("deleteModal");
            deleteModal.classList.add("hidden");
            deleteModal.classList.remove("flex");
            if (onDeleteConfirm) onDeleteConfirm();
        };

        renderCart();
    });

    const COOKIE_NAME = 'guest_cart';

    function getCart() {
        const match = document.cookie.match(new RegExp('(^| )' + COOKIE_NAME + '=([^;]+)'));
        return match ? JSON.parse(decodeURIComponent(match[2])) : [];
    }

    function saveCart(cart) {
        document.cookie = `${COOKIE_NAME}=${encodeURIComponent(JSON.stringify(cart))}; path=/; max-age=${60 * 60 * 24 * 3}`;
    }

    function removeAll() {
        showDeleteModal(() => {
            saveCart([]);
            renderCart();
        });
    }

    function removeSelected() {
        const selectedIds = Array.from(document.querySelectorAll(".cart-check:checked"))
            .map(cb => Number(cb.value));

        if (selectedIds.length === 0) {
            alert("삭제할 항목을 선택해주세요.");
            return;
        }

        showDeleteModal(() => {
            const updatedCart = getCart().filter(item => !selectedIds.includes(item.bookId));
            saveCart(updatedCart);
            renderCart();
        });
    }

    function updatePriceSummary(cart) {
        const orderPrice = cart.reduce((acc, cur) => acc + (cur.price * cur.quantity), 0);
        const discount = Math.floor(orderPrice * 0.05); // 5% 할인 예시
        const total = orderPrice - discount;

        document.getElementById("order-price").textContent = `￦${orderPrice.toLocaleString()}`;
        document.getElementById("discount-price").textContent = `-￦${discount.toLocaleString()}`;
        document.getElementById("total-price").textContent = `￦${total.toLocaleString()}`;
    }

    function renderCart() {
        const cart = getCart();
        const list = document.getElementById("cart-list");
        list.innerHTML = "";

        if (cart.length === 0) {
            list.innerHTML = "<li class='text-center text-gray-600'>장바구니가 비어 있습니다.</li>";
            return;
        }

        cart.forEach(item => {
            const li = document.createElement("li");
            li.className = "flex items-center gap-4 border-t pt-4";

            li.innerHTML = `
                <input type="checkbox" class="cart-check" value="${item.bookId}">
                <img src="${item.thumbnailUrl || 'https://via.placeholder.com/80'}" alt="${item.title}" class="w-20 h-20 object-cover rounded" />
                <div class="flex-1">
                    <div class="text-lg font-semibold text-gray-900">${item.title || "상품명"}</div>
                    <div class="text-sm text-gray-700">수량: ${item.quantity}</div>
                    <div class="text-sm text-gray-700">가격: ₩${item.price?.toLocaleString() || "0"}</div>

                    <div class="mt-2">
                        <label for="couponSelect_${item.bookId}" class="block text-sm font-medium text-gray-700">쿠폰 선택</label>
                        <select
                            id="couponSelect_${item.bookId}"
                            name="couponSelect_${item.bookId}"
                            class="mt-1 block w-40 rounded-md border border-gray-300 bg-white py-2 px-3 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                        >
                            <option value="">쿠폰을 선택하세요</option>
                            <option value="10off">생일 쿠폰 (-5,000)</option>
                            <option value="freedelivery">무료배송 쿠폰 (-3,000)</option>
                        </select>
                    </div>
                </div>
            `;
            list.appendChild(li);
        });

        updatePriceSummary(cart);

        document.getElementById('selectAll').addEventListener('change', function () {
            document.querySelectorAll('.cart-check').forEach(cb => cb.checked = this.checked);
        });
    }

    document.addEventListener("DOMContentLoaded", renderCart);
</script>

<div id="deleteModal" class="fixed inset-0 z-50 bg-white/10 backdrop-blur-sm hidden justify-center items-center">
    <div class="bg-white rounded-lg p-6 w-80 shadow-lg text-center border border-black">
        <p class="text-lg font-semibold mb-4">선택한 상품을 삭제하시겠습니까?</p>
        <div class="flex justify-end gap-2">
            <button id="cancelBtn" class="px-4 py-2 text-sm rounded bg-gray-200 hover:bg-gray-300">취소</button>
            <button id="confirmBtn" class="px-4 py-2 text-sm rounded bg-red-500 text-white hover:bg-red-600">삭제</button>
        </div>
    </div>
</div>
</body>
</html>

<!-- 더미데이터
document.cookie = `guest_cart=${encodeURIComponent(JSON.stringify([
{ bookId: 1, title: "테스트 도서 A", quantity: 2, price: 15000, thumbnailUrl: "https://via.placeholder.com/80" },
{ bookId: 2, title: "테스트 도서 B", quantity: 1, price: 22000, thumbnailUrl: "https://via.placeholder.com/80" },
{ bookId: 3, title: "테스트 도서 C", quantity: 10, price: 30000, thumbnailUrl: "https://via.placeholder.com/80" }
]))}; path=/; max-age=${60 * 60 * 24 * 3}`;
-->
