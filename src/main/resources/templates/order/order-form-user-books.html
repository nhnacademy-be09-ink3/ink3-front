<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ink3</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/output.css(v=${#dates.createNow().getTime()})}">
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100">
<div th:replace="~{layout/fragments/header :: headerFragment}"></div>
<main class="container max-w-[1600px] mx-auto px-4 py-8">
    <div class="flex flex-col lg:flex-row gap-10">

        <!-- ì™¼ìª½: ì…ë ¥ -->
        <div class="w-full lg:w-[70%] bg-white p-8 rounded-xl shadow">
            <!-- ì£¼ë¬¸ ìƒí’ˆ ëª©ë¡ -->
            <section class="mb-8">
                <h2 class="text-2xl font-semibold mb-4">ì£¼ë¬¸ ìƒí’ˆ</h2>
                <!-- ì£¼ë¬¸ ìƒí’ˆ ì¹´ë“œ: ê°€ë¡œ ì •ë ¬ -->
                <div th:each="item : ${cart}"
                     class="cart-item bg-white p-4 rounded-xl shadow text-sm flex items-center gap-6 mb-4"
                     th:attr="data-book-id=${item.bookId}, data-price=${item.saleBookPrice}, data-quantity=${item.quantity}">

                    <!-- ì´ë¯¸ì§€ -->
                    <div class="w-16 flex-shrink-0">
                        <img th:src="${item.thumbnailUrl}" alt="ë„ì„œ ì´ë¯¸ì§€"
                             class="w-full h-auto rounded border border-gray-200">
                    </div>

                    <!-- ìƒí’ˆëª… -->
                    <div class="min-w-[130px]">
                        <div class="text-gray-500 text-xs">ìƒí’ˆëª…</div>
                        <div class="font-medium text-gray-800" th:text="${item.bookTitle}">ë„ì„œ ì œëª©</div>
                    </div>

                    <!-- ì •ê°€ -->
                    <div class="min-w-[70px]">
                        <div class="text-gray-500 text-xs">ì •ê°€</div>
                        <div th:text="${#numbers.formatInteger(item.originalBookPrice, 0, 'COMMA') + 'ì›'}">ì •ê°€</div>
                    </div>

                    <!-- ìˆ˜ëŸ‰ -->
                    <div class="min-w-[60px]">
                        <div class="text-gray-500 text-xs">ìˆ˜ëŸ‰</div>
                        <div th:text="${item.quantity + 'ê°œ'}">0ê°œ</div>
                    </div>

                    <!-- í• ì¸ê¸ˆì•¡ -->
                    <div class="min-w-[90px]">
                        <div class="text-gray-500 text-xs">í• ì¸ê¸ˆì•¡</div>
                        <div class="text-red-600 font-semibold"
                             th:text="${#numbers.formatInteger(item.saleBookPrice, 0, 'COMMA') + 'ì›'}">
                            í• ì¸ê¸ˆì•¡
                        </div>
                        <div class="text-xs text-red-500"
                             th:if="${item.bookDiscountRate != null}"
                             th:text="|(${item.bookDiscountRate}% â†“)|">
                        </div>                    </div>

                    <!-- í•©ê³„ -->
                    <div class="min-w-[90px] text-right">
                        <div class="text-gray-500 text-xs">í•©ê³„</div>
                        <div class="text-base font-bold text-gray-900"
                             th:text="${#numbers.formatInteger(item.saleBookPrice * item.quantity, 0, 'COMMA') + 'ì›'}">
                            í•©ê³„
                        </div>
                    </div>

                    <!-- í¬ì¥ì§€ + ì¿ í° ì„ íƒ (ì„¸ë¡œ ë°°ì¹˜) -->
                    <div class="w-full flex flex-col gap-4 mt-4">

                        <!-- í¬ì¥ì§€ ì„ íƒ -->
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700 whitespace-nowrap w-[90px]">í¬ì¥ì§€ ì„ íƒ</label>
                            <select class="packaging-select ink-input-field w-full sm:w-[240px]"
                                    th:disabled="${!item.isPackable}"
                                    th:classappend="${!item.isPackable} ? ' bg-gray-100 text-gray-400 cursor-not-allowed'">
                                <option th:if="${item.isPackable}" value="">í¬ì¥ì§€ ì„ íƒ ì•ˆ í•¨</option>
                                <option th:unless="${item.isPackable}" disabled selected>í¬ì¥ì§€ ì„ íƒ ë¶ˆê°€ ìƒí’ˆ</option>
                                <option th:each="p : ${packagings}"
                                        th:value="${p.id}"
                                        th:text="${p.name + ' (' + #numbers.formatInteger(p.price, 0, 'COMMA') + 'ì›)'}"
                                        th:attr="data-price=${p.price}"
                                        th:disabled="${!p.isAvailable}">
                                </option>
                            </select>
                        </div>

                        <!-- ì¿ í° ì„ íƒ -->
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700 whitespace-nowrap w-[90px]">ì¿ í° ì„ íƒ</label>
                            <select class="ink-input-field w-full sm:w-[240px]"
                                    name="couponId"
                                    th:id="'coupon-select-' + ${item.bookId}"
                                    th:disabled="${item.applicableCoupons == null or item.applicableCoupons.isEmpty()}"
                                    th:classappend="${item.applicableCoupons == null or item.applicableCoupons.isEmpty()} ? ' bg-gray-100 text-gray-400 cursor-not-allowed'">

                                <!-- ì¿ í°ì´ ì—†ëŠ” ê²½ìš° -->
                                <option th:if="${item.applicableCoupons == null or item.applicableCoupons.isEmpty()}" disabled selected>
                                    ì¿ í° ì„ íƒ ë¶ˆê°€
                                </option>

                                <!-- ì¿ í°ì´ ìˆëŠ” ê²½ìš° -->
                                <option th:if="${item.applicableCoupons != null and !item.applicableCoupons.isEmpty()}" value="">
                                    ì¿ í° ì„ íƒ ì•ˆ í•¨
                                </option>
                                <option th:each="c : ${item.applicableCoupons}"
                                        th:value="${c.storeId}"
                                        th:utext="${c.couponName + ' - ' +
                                          (c.discountType == 'FIXED' ?
                                            #numbers.formatInteger(c.discountValue, 0, 'COMMA') + 'ì› í• ì¸' :
                                            c.discountPercentage + '% í• ì¸' +
                                            (c.maximumDiscountAmount != null ? ' (ìµœëŒ€ ' + #numbers.formatInteger(c.maximumDiscountAmount, 0, 'COMMA') + 'ì›)' : '')
                                          ) + '&#10;ë§Œë£Œì¼: ' + #temporals.format(c.expiresAt, 'yyyy-MM-dd HH:mm')}"
                                        th:attr="data-coupon-id=${c.couponId},
                                         data-discount-type=${c.discountType},
                                         data-discount-value=${c.discountValue},
                                         data-discount-percentage=${c.discountPercentage},
                                         data-max-discount=${c.maximumDiscountAmount}">
                                </option>
                            </select>
                            <style>
                                select option {
                                    white-space: pre-line;
                                    font-size: 14px;
                                    line-height: 1.4;
                                    padding: 4px 8px;
                                }
                                .disabled-select {
                                    background-color: #f3f4f6;
                                    cursor: not-allowed;
                                    color: #9ca3af;
                                }
                            </style>
                        </div>

                    </div>

                </div>


            </section>


            <!-- ì£¼ë¬¸ì ì •ë³´ -->
            <section class="mb-8">
                <!-- ì£¼ë¬¸ì ì •ë³´ ì œëª© + ë²„íŠ¼ í•œ ì¤„ ë°°ì¹˜ -->
                <div class="flex justify-between items-center mt-10 mb-4">
                    <h2 class="text-2xl font-semibold">ì£¼ë¬¸ì ì •ë³´</h2>
                    <button type="button" id="loadMyInfoBtn" class="ink-btn-primary text-sm px-4 py-2">
                        ë‚´ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    </button>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg shadow space-y-6 text-sm">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-1 text-sm font-medium text-gray-700">ì´ë¦„</label>
                            <input type="text" class="ink-input-field w-full" id="ordererName" placeholder="í™ê¸¸ë™">
                        </div>
                        <div>
                            <label class="block mb-1 text-sm font-medium text-gray-700">ì—°ë½ì²˜</label>
                            <input type="text" class="ink-input-field w-full" id="ordererPhone" placeholder="010-9876-5432">
                        </div>
                    </div>
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-700">ì´ë©”ì¼</label>
                        <input type="email" class="ink-input-field w-full" id="ordererEmail"
                               placeholder="example@email.com">
                    </div>
                </div>
                <input type="hidden" id="userId" th:value="${user.id}" />
                <input type="hidden" id="userName" th:value="${user.name}">
                <input type="hidden" id="userPhone" th:value="${user.phone}">
                <input type="hidden" id="userEmail" th:value="${user.email}">
            </section>

            <!-- ë°°ì†¡ì§€ ì •ë³´ -->
            <section class="mb-8">
                <!-- ë°°ì†¡ì§€ ì •ë³´ -->
                <section class="mb-8">
                    <h2 class="text-2xl font-semibold mt-10 mb-4">ë°°ì†¡ì§€ ì •ë³´</h2>

                    <!-- ë°°ì†¡ì§€ ì…ë ¥ ë°©ì‹ ë¼ë””ì˜¤ -->
                    <div class="mb-4">
                        <label class="block mb-1 text-sm font-medium text-gray-700">ë°°ì†¡ì§€ ì…ë ¥ ë°©ì‹</label>
                        <div class="flex gap-4">
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="addressType" value="search" checked class="accent-indigo-600">
                                <span>ì£¼ì†Œ ê²€ìƒ‰</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="addressType" value="book" class="accent-indigo-600">
                                <span>ì£¼ì†Œë¡</span>
                            </label>
                        </div>
                    </div>

                    <!-- ì£¼ì†Œ ì…ë ¥ í•„ë“œ -->
                    <div class="bg-gray-50 p-4 rounded-lg shadow space-y-6 text-sm">

                        <!-- ìˆ˜ë ¹ì¸ & ì—°ë½ì²˜ -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700">ìˆ˜ë ¹ì¸</label>
                                <input type="text" class="ink-input-field w-full" id="recipientName" placeholder="ìˆ˜ë ¹ì¸">
                            </div>
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700">ì—°ë½ì²˜</label>
                                <input type="text" class="ink-input-field w-full" id="recipientPhone"  placeholder="010-9876-5432">
                            </div>
                        </div>

                        <!-- ì£¼ì†Œ -->
                        <div class="flex flex-col gap-3">
                            <label class="block mb-1 text-sm font-medium text-gray-700">ë°°ì†¡ ì£¼ì†Œ</label>
                            <div class="flex flex-col space-y-[16px]">
                                <!-- ìš°í¸ë²ˆí˜¸ + ë²„íŠ¼ -->
                                <div class="flex gap-2">
                                    <input type="text" id="postalCode" class="ink-input-field w-[30%]"
                                           placeholder="ìš°í¸ë²ˆí˜¸" readonly>
                                    <button type="button" onclick="execDaumPostcode()"
                                            class="ink-btn-primary text-sm px-4 py-2 h-full">
                                        ìš°í¸ë²ˆí˜¸ ì°¾ê¸°
                                    </button>
                                </div>

                                <!-- ë„ë¡œëª… ì£¼ì†Œ -->
                                <input type="text" id="defaultAddress" class="ink-input-field w-full"
                                       placeholder="ë„ë¡œëª… ì£¼ì†Œ" readonly>

                                <!-- ìƒì„¸ ì£¼ì†Œ -->
                                <input type="text" id="detailAddress" class="ink-input-field w-full"
                                       placeholder="ìƒì„¸ ì£¼ì†Œ ì…ë ¥">

                                <!-- ì°¸ê³  ì£¼ì†Œ -->
                                <input type="text" id="extraAddress" class="ink-input-field w-full"
                                       placeholder="ì°¸ê³  ì£¼ì†Œ ì…ë ¥">
                            </div>
                        </div>

                        <!-- í¬ë§ ë°°ì†¡ì¼ -->
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-700">í¬ë§ ë°°ì†¡ì¼</label>

                            <!-- ê¸°ë³¸ ë°°ì†¡ì¼ ì•ˆë‚´ -->
                            <div class="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-2 rounded-md text-sm mb-4">
                                ê¸°ë³¸ ë°°ì†¡ ì˜ˆì •ì¼ì€ <strong id="defaultDeliveryDate">2025-06-02</strong> ì…ë‹ˆë‹¤.
                            </div>

                            <!-- ë°°ì†¡ì¼ ì§€ì • ìŠ¤ìœ„ì¹˜ -->
                            <div class="flex items-center gap-4 mb-4">
                                <label for="enablePreferredDate" class="inline-flex items-center cursor-pointer">
                                    <span class="mr-3 text-sm text-gray-700">ë°°ì†¡ì¼ ì§€ì •</span>
                                    <div class="relative">
                                        <input type="checkbox" id="enablePreferredDate" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-300 rounded-full peer peer-checked:bg-indigo-500 transition-all"></div>
                                        <div class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow peer-checked:translate-x-full transition-transform"></div>
                                    </div>
                                </label>
                            </div>

                            <!-- ë‚ ì§œ ì„ íƒ input -->
                            <div>
                                <input type="date" id="preferredDeliveryDateInput"
                                       class="ink-input-field w-full sm:w-[250px] bg-white text-gray-800 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                                       disabled
                                       min="2025-06-02"
                                >
                            </div>
                        </div>

                    </div>
                </section>

                <!-- ì£¼ì†Œë¡ ëª¨ë‹¬ -->
                <div id="addressModal"
                     class="fixed inset-0 bg-black/10 hidden flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold">ì£¼ì†Œë¡</h2>
                            <button id="closeAddressModal"
                                    class="text-gray-500 hover:text-gray-700 text-xl leading-none">&times;
                            </button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left border border-gray-200">
                                <thead class="bg-gray-100 text-gray-700">
                                <tr>
                                    <th class="px-4 py-2 border">ì„ íƒ</th>
                                    <th class="px-4 py-2 border">ì£¼ì†Œëª…</th>
                                    <th class="px-4 py-2 border">ì£¼ì†Œ</th>
                                    <th class="px-4 py-2 border">ìš°í¸ë²ˆí˜¸</th>
                                    <th class="px-4 py-2 border">ê¸°ë³¸</th>
                                    <th class="px-4 py-2 border">ì„ íƒ</th>
                                </tr>
                                </thead>
                                <tbody id="modalAddressTableBody">
                                <tr th:each="addr : ${addressList}">
                                    <td class="px-4 py-2 border text-center">
                                        <input type="radio" name="selectedAddr">
                                    </td>
                                    <td class="px-4 py-2 border" th:text="${addr.name}" th:attr="data-label=${addr.name}">ì§‘</td>
                                    <td class="px-4 py-2 border"
                                        th:text="${addr.defaultAddress + ' ' + addr.detailAddress + ' ' + (addr.extraAddress ?: '')}">
                                        ì£¼ì†Œ
                                    </td>
                                    <td class="px-4 py-2 border" th:text="${addr.postalCode}">12345</td>
                                    <td class="px-4 py-2 border text-center"
                                        th:text="${addr.isDefault ? 'ê¸°ë³¸' : ''}"></td>
                                    <td class="px-4 py-2 border text-center">
                                        <button type="button"
                                                class="ink-btn-primary text-sm px-2 py-1"
                                                th:attr="data-name=${addr.name},
                                                         data-postal-code=${addr.postalCode},
                                                         data-default-address=${addr.defaultAddress},
                                                         data-detail-address=${addr.detailAddress},
                                                         data-extra-address=${addr.extraAddress}">
                                            ì„ íƒ
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>


            <!-- í¬ì¸íŠ¸ -->
            <section>
                <h2 class="text-2xl font-semibold mt-10 mb-4">í¬ì¸íŠ¸</h2>

                <div class="bg-gray-50 p-4 rounded-lg shadow space-y-6 text-sm">

                    <!-- í¬ì¸íŠ¸ ì…ë ¥ -->
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-700">í¬ì¸íŠ¸ ì‚¬ìš©</label>
                        <div class="flex flex-col sm:flex-row gap-2 items-center">
                            <input
                                    type="number"
                                    class="ink-input-field w-full sm:w-[60%]"
                                    placeholder="ì‚¬ìš©í•  í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                    name="usedPoint"
                                    th:attr="max=${user.point}"
                            />
                            <button
                                    type="button"
                                    id="applyPointBtn"
                                    class="ink-btn-primary w-full sm:w-[20%] text-sm"
                            >
                                ì ìš©
                            </button>
                            <label for="useAllPointChk" class="inline-flex items-center cursor-pointer mt-2 sm:mt-0 sm:w-[20%]">
                                <span class="mr-3 text-sm text-gray-700">ì „ì²´ ì‚¬ìš©</span>
                                <div class="relative">
                                    <input type="checkbox" id="useAllPointChk" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-300 rounded-full peer peer-checked:bg-indigo-500 transition-all"></div>
                                    <div class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow peer-checked:translate-x-full transition-transform"></div>
                                </div>
                            </label>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            ë³´ìœ  í¬ì¸íŠ¸:
                            <span class="text-gray-700 font-semibold"
                                  th:text="${#numbers.formatInteger(user.point, 0, 'COMMA') + 'P'}">0P</span><br/>
                            <span class="text-red-500">
                                â€» ìµœëŒ€ <span id="allowedPointText" th:text="${user.point}">0</span>P ê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                            </span>
                        </p>
                    </div>

                </div>
            </section>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ìš”ì•½ -->
        <div class="w-full lg:w-[30%]">
            <div class="sticky top-6 bg-white p-6 rounded-xl shadow min-h-[75vh] flex flex-col justify-between">
                <div>
                    <h2 class="text-xl font-bold border-b pb-2 mb-4">ì£¼ë¬¸ ìš”ì•½</h2>
                    <div class="space-y-2 text-sm mb-6">
                        <!-- ìƒí’ˆë³„ ìš”ì•½ ë°˜ë³µ ë Œë”ë§ -->
                        <div th:each="item : ${cart}" class="flex justify-between">
                            <span th:text="${item.bookTitle}">ë„ì„œëª…</span>
                            <span th:text="${item.quantity + 'ê°œ / ' + (#numbers.formatInteger(item.saleBookPrice * item.quantity, 0, 'COMMA') + 'ì›')}">0ê°œ / 0ì›</span>
                        </div>
                    </div>

                    <h2 class="text-xl font-bold border-b pb-2 mb-4">ê²°ì œ ë‚´ì—­</h2>
                    <div class="space-y-2 text-sm">
                        <!-- ìƒí’ˆ ì´ì•¡ -->
                        <div class="flex justify-between">
                            <span>ìƒí’ˆ ì´ì•¡</span>
                            <span><span data-role="product-total">0ì›</span></span>
                        </div>

                        <!-- í• ì¸ -->
                        <div class="flex justify-between">
                            <span>í• ì¸</span>
                            <span data-role="coupon-discount">0ì›</span>
                        </div>

                        <!-- ë°°ì†¡ë¹„ -->
                        <div class="flex justify-between">
                            <span>ë°°ì†¡ë¹„</span>
                            <span><span data-role="shipping-fee">3,000ì›</span></span>
                        </div>
                        <script th:inline="javascript">
                            const SHIPPING_POLICY = {
                                threshold: [[${activeShippingPolicy.threshold}]],
                                fee: [[${activeShippingPolicy.fee}]]
                            };
                        </script>

                        <!-- í¬ì¥ì§€ ë¹„ìš© -->
                        <div class="flex justify-between">
                            <span>í¬ì¥ì§€ ë¹„ìš©</span>
                            <span><span data-role="packaging-total">0ì›</span></span>
                        </div>

                        <!-- í¬ì¸íŠ¸ ì‚¬ìš© -->
                        <div class="flex justify-between">
                            <span>í¬ì¸íŠ¸ ì‚¬ìš©</span>
                            <span><span data-role="point-used">0ì›</span></span>
                        </div>

                        <!-- ìµœì¢… ê²°ì œ ê¸ˆì•¡ -->
                        <div class="flex justify-between font-bold text-base">
                            <span>ìµœì¢… ê²°ì œ</span>
                            <span><span data-role="final-total">0ì›</span></span>
                        </div>
                    </div>
                </div>

                <button type="button" onclick="submitOrderForm()" class="ink-btn-primary mt-8 w-full text-base py-2">
                    ê²°ì œí•˜ê¸°
                </button>

            </div>
        </div>
    </div>
    <!-- âœ… 0ì› ê²°ì œ í™•ì¸ ëª¨ë‹¬ -->
    <div id="zeroPaymentModal" class="fixed inset-0 bg-black/50 z-50 hidden justify-center items-center">
        <div class="bg-white rounded-xl shadow-xl p-6 max-w-lg w-full">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ê²°ì œ í™•ì¸</h2>
            <p class="text-gray-700 mb-6">
                ì‚¬ìš©í•˜ì‹  í¬ì¸íŠ¸ì™€ í• ì¸ìœ¼ë¡œ ì¸í•´ ê²°ì œ ê¸ˆì•¡ì´ <strong class="text-red-600">0ì›</strong>ì…ë‹ˆë‹¤.<br>
                ì•„ë˜ ê²°ì œ ë‚´ì—­ì„ í™•ì¸í•˜ê³  ì£¼ë¬¸ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
            </p>

            <!-- ì˜ìˆ˜ì¦ í˜•ì‹ ê²°ì œ ìš”ì•½ -->
            <table class="w-full text-sm text-gray-700 mb-6">
                <tbody>
                <tr class="border-t">
                    <td class="py-2">ìƒí’ˆ ì´ì•¡</td>
                    <td class="py-2 text-right font-medium" id="receiptProductTotal">0ì›</td>
                </tr>
                <tr>
                    <td class="py-2">ë°°ì†¡ë¹„</td>
                    <td class="py-2 text-right" id="receiptShippingFee">0ì›</td>
                </tr>
                <tr>
                    <td class="py-2">í¬ì¥ì§€ ë¹„ìš©</td>
                    <td class="py-2 text-right" id="receiptPackagingTotal">0ì›</td>
                </tr>
                <tr>
                    <td class="py-2">í• ì¸ ê¸ˆì•¡</td>
                    <td class="py-2 text-right text-green-600" id="receiptDiscountAmount">-0ì›</td>
                </tr>
                <tr>
                    <td class="py-2">í¬ì¸íŠ¸ ì‚¬ìš©</td>
                    <td class="py-2 text-right text-blue-600" id="receiptUsedPoint">-0P</td>
                </tr>
                <tr class="border-t font-bold">
                    <td class="py-2">ìµœì¢… ê²°ì œ ê¸ˆì•¡</td>
                    <td class="py-2 text-right text-red-600">0ì›</td>
                </tr>
                </tbody>
            </table>

            <div class="flex justify-end gap-3">
                <button onclick="closeZeroModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">ì·¨ì†Œ</button>
                <button onclick="submitZeroPayment()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">í™•ì¸</button>
            </div>
        </div>
    </div>
</main>
<div th:replace="~{layout/fragments/footer :: footerFragment}"></div>
</body>
</html>


<script th:inline="javascript">

    document.addEventListener("DOMContentLoaded", () => {
        initDeliveryDate(); // í¬ë§ ë°°ì†¡ì¼
        initAutoHyphen(["ordererPhone", "recipientPhone"]); // ì „í™”ë²ˆí˜¸ í•˜ì´í° ì ìš©
        initMyInfoBtn(); // ë‚´ì •ë³´ ìë™ ì…ë ¥
        initAddressRadio(); // ì£¼ì†Œ ì ìš©
        initAddressModal(); // ì£¼ì†Œ ëª¨ë‹¬ ë„ìš°ê¸°
        initCouponSelect(); // ì¿ í° ì ìš©
        initPackagingSelect(); // í¬ì¥ì§€ ì ìš©
        initPointEvents(); // í¬ì¸íŠ¸ ì ìš©
        updateSummary(); // ê²°ì œ ê¸ˆì•¡ ê³„ì‚°
    });

    // ğŸ“Œ í¬ë§ ë°°ì†¡ì¼ ì´ˆê¸°í™”
    function initDeliveryDate() {
        const checkbox = document.getElementById("enablePreferredDate");
        const dateInput = document.getElementById("preferredDeliveryDateInput");

        checkbox?.addEventListener("change", () => {
            dateInput.disabled = !checkbox.checked;
        });

        const defaultDate = new Date();
        defaultDate.setDate(defaultDate.getDate() + 2);
        const formatted = defaultDate.toISOString().split('T')[0];

        document.getElementById("defaultDeliveryDate").textContent = formatted;
        dateInput.min = formatted;
        dateInput.value = formatted;

        window.getPreferredDeliveryDate = () => checkbox.checked ? dateInput.value : formatted;
    }

    // ğŸ“Œ ì „í™”ë²ˆí˜¸ í•˜ì´í”ˆ ìë™ ì…ë ¥
    function initAutoHyphen(ids) {
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener("input", (e) => {
                const num = e.target.value.replace(/\D/g, "");
                e.target.value = num.length <= 10
                    ? num.replace(/(\d{2,3})(\d{3,4})(\d{4})/, "$1-$2-$3")
                    : num;
            });
        });
    }

    // ğŸ“Œ ë‚´ ì •ë³´ ìë™ ì…ë ¥ ë²„íŠ¼
    function initMyInfoBtn() {
        const btn = document.getElementById("loadMyInfoBtn");
        btn?.addEventListener("click", () => {
            document.getElementById("ordererName").value = document.getElementById("userName")?.value || "";
            document.getElementById("ordererPhone").value = document.getElementById("userPhone")?.value || "";
            document.getElementById("ordererEmail").value = document.getElementById("userEmail")?.value || "";
        });
    }

    // ğŸ“Œ ì£¼ì†Œ ì…ë ¥ ë°©ì‹ (ê²€ìƒ‰/ì£¼ì†Œë¡) ë¼ë””ì˜¤ ì²˜ë¦¬
    function initAddressRadio() {
        document.querySelectorAll('input[name="addressType"]').forEach(radio => {
            radio.addEventListener("change", (e) => {
                const modal = document.getElementById("addressModal");
                if (e.target.value === "book") {
                    modal.classList.remove("hidden");
                } else {
                    ["recipientPhone", "postalCode", "defaultAddress", "detailAddress", "extraAddress"]
                        .forEach(id => document.getElementById(id).value = "");
                }
            });
        });
    }

    // ğŸ“Œ ì£¼ì†Œë¡ ëª¨ë‹¬ ì´ë²¤íŠ¸
    function initAddressModal() {
        document.getElementById("closeAddressModal")?.addEventListener("click", () => {
            document.getElementById("addressModal").classList.add("hidden");
        });

        document.querySelectorAll('button[data-name]').forEach(btn => {
            btn.addEventListener("click", () => {
                ["postalCode", "defaultAddress", "detailAddress", "extraAddress"].forEach(key => {
                    document.getElementById(key).value = btn.dataset[key] || "";
                });
                document.getElementById("addressModal").classList.add("hidden");
            });
        });
    }

    // ğŸ“Œ ì¿ í° ì„ íƒ ì‹œ ë‹¤ë¥¸ í•­ëª© disable ì²˜ë¦¬
    function initCouponSelect() {
        document.querySelectorAll('select[name="couponId"]').forEach(select => {
            select.addEventListener('change', () => {
                const selected = select.value;
                document.querySelectorAll('select[name="couponId"]').forEach(other => {
                    other.disabled = selected && other !== select;
                    other.classList.toggle('disabled-select', selected && other !== select);
                });

                // ğŸ”¥ í¬ì¸íŠ¸ ì „ì²´ ì‚¬ìš© ì ìš© ì—¬ë¶€ ë°˜ì˜
                const input = document.querySelector('input[name="usedPoint"]');
                const before = usedPoint;
                const useAllChk = document.getElementById('useAllPointChk');
                if (useAllChk?.checked) {
                    handlePointToggle(input, useAllChk); // âœ… ë‹¤ì‹œ ê³„ì‚°
                } else {
                    updateSummary(); // ê·¸ëƒ¥ ê°±ì‹ 
                }

                // ğŸ”¥ í¬ì¸íŠ¸ê°€ ì¤„ì—ˆë‹¤ë©´ ì•Œë¦¼
                if (usedPoint < before) {
                    showPointAdjustedAlert(usedPoint, "í• ì¸ ì¿ í° ì ìš©");
                }
            });
        });
    }

    // ğŸ“Œ í¬ì¥ì§€ ì„ íƒ ì‹œ ì´í•© ê°±ì‹ 
    function initPackagingSelect() {
        document.querySelectorAll('select.packaging-select').forEach(select =>
            select.addEventListener('change', updateSummary)
        );
    }

    // ğŸ“Œ í¬ì¸íŠ¸ ì ìš© ë° ì „ì²´ ì‚¬ìš© ì²˜ë¦¬
    function initPointEvents() {
        const input = document.querySelector('input[name="usedPoint"]');
        const applyBtn = document.getElementById('applyPointBtn');
        const useAllChk = document.getElementById('useAllPointChk');

        applyBtn?.addEventListener('click', () => handlePointApply(input, useAllChk));
        useAllChk?.addEventListener('change', () => handlePointToggle(input, useAllChk));
    }

    let usedPoint = 0;

    // ğŸ“Œ í¬ì¸íŠ¸ ì ìš© ë²„íŠ¼ ì²˜ë¦¬
    function handlePointApply(input, checkbox) {
        const max = parseInt(input.getAttribute("max") || "0", 10);
        const val = parseInt(input.value || "0", 10);
        const { paymentAmountBeforePoint } = getSummary();

        const allowedPoint = Math.min(max, paymentAmountBeforePoint);
        if (val > allowedPoint) {
            usedPoint = allowedPoint;
            input.value = usedPoint;
            showPointAdjustedAlert(usedPoint, "í• ì¸ ì¿ í° ì ìš©");
        } else {
            usedPoint = val;
        }

        checkbox.checked = usedPoint === max;
        updateSummary();
    }

    // ğŸ“Œ í¬ì¸íŠ¸ ì „ì²´ ì‚¬ìš© ìŠ¤ìœ„ì¹˜ ì²˜ë¦¬
    function handlePointToggle(input, checkbox) {
        const max = parseInt(input.getAttribute("max") || "0", 10);
        const { paymentAmountBeforePoint } = getSummary();
        const allowedPoint = Math.min(max, paymentAmountBeforePoint);

        usedPoint = checkbox.checked ? allowedPoint : 0;
        input.value = usedPoint;

        updateSummary();
    }

    // ğŸ“Œ í¬ì¸pointMessageíŠ¸ ì¡°ì • ì•ŒëŒ
    function showPointAdjustedAlert(amount, reason) {
        // ë„ˆë¬´ ìì£¼ ëœ¨ì§€ ì•Šê²Œ ë°©ì§€ (1ì´ˆ ë‚´ì— ì¤‘ë³µ ë°©ì§€ìš©)
        if (window.__lastPointAlertTime && Date.now() - window.__lastPointAlertTime < 1000) return;
        window.__lastPointAlertTime = Date.now();

        alert(`${reason}ìœ¼ë¡œ ì¸í•´ í¬ì¸íŠ¸ ì‚¬ìš© ê¸ˆì•¡ì´ ${formatCurrency(amount)}ìœ¼ë¡œ ì¡°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    // ğŸ“Œ í™”ë©´ ë‚´ í†µí™” í¬ë§·
    function formatCurrency(num) {
        return new Intl.NumberFormat('ko-KR').format(num) + 'ì›';
    }

    // ğŸ“Œ ê²°ì œ ìš”ì•½ ì—…ë°ì´íŠ¸
    function updateSummary() {
        const {
            productTotal,
            packagingTotal,
            couponDiscountTotal,
            shippingFee,
            paymentAmountBeforePoint
        } = getSummary();

        const pointInput = document.querySelector('input[name="usedPoint"]');
        const maxPoint = parseInt(pointInput.getAttribute("max") || "0", 10);
        const inputVal = parseInt(pointInput.value || "0", 10);

        const useAllChk = document.getElementById('useAllPointChk');
        const wasChecked = useAllChk?.checked;

        const newAllowedPoint = Math.min(inputVal, maxPoint, paymentAmountBeforePoint);

        if (wasChecked) {
            const adjusted = Math.min(maxPoint, paymentAmountBeforePoint);
            if (usedPoint !== adjusted) {
                usedPoint = adjusted;
                pointInput.value = usedPoint;
                showPointAdjustedAlert(usedPoint, "í¬ì¥ì§€ ì„ íƒ");
            }
        } else {
            if (inputVal > newAllowedPoint) {
                usedPoint = newAllowedPoint;
                pointInput.value = usedPoint;
            } else {
                usedPoint = inputVal;
            }
        }

        const paymentAmount = Math.max(paymentAmountBeforePoint - usedPoint, 0);

        // ê°€ê²© ë Œë”ë§ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
        document.querySelector('[data-role="product-total"]').textContent = formatCurrency(productTotal);
        document.querySelector('[data-role="packaging-total"]').textContent = formatCurrency(packagingTotal);
        document.querySelector('[data-role="coupon-discount"]').textContent = '-' + formatCurrency(couponDiscountTotal);
        document.querySelector('[data-role="shipping-fee"]').textContent = formatCurrency(shippingFee);
        document.querySelector('[data-role="point-used"]').textContent = formatCurrency(usedPoint);
        document.querySelector('[data-role="final-total"]').textContent = formatCurrency(paymentAmount);
    }

    // ğŸ“Œ ê¸ˆì•¡ ê³„ì‚° ë¡œì§
    function getSummary() {
        let productTotal = 0, packagingTotal = 0, couponDiscountTotal = 0;

        document.querySelectorAll(".cart-item").forEach(item => {
            const price = parseInt(item.dataset.price || "0");
            const quantity = parseInt(item.dataset.quantity || "0");
            productTotal += price * quantity;

            const pkgPrice = parseInt(item.querySelector('select.packaging-select')?.selectedOptions[0]?.dataset.price || "0");
            packagingTotal += pkgPrice;

            const coupon = item.querySelector('select[name="couponId"]')?.selectedOptions[0];
            if (coupon) {
                const type = coupon.dataset.discountType;
                const value = parseInt(coupon.dataset.discountValue || "0");
                const percent = parseInt(coupon.dataset.discountPercentage || "0");
                const max = parseInt(coupon.dataset.maxDiscount || "0");

                let discount = 0;
                const total = price * quantity;
                if (type === "FIXED") {
                    discount = Math.min(value, total);
                } else if (type === "RATE") {
                    discount = Math.floor(total * percent / 100);
                    if (max) discount = Math.min(discount, max);
                    discount = Math.min(discount, total);
                }
                couponDiscountTotal += discount;
            }
        });

        const shippingFee = productTotal >= SHIPPING_POLICY.threshold ? 0 : SHIPPING_POLICY.fee;
        return {
            productTotal,
            packagingTotal,
            couponDiscountTotal,
            shippingFee,
            paymentAmountBeforePoint: productTotal + packagingTotal + shippingFee - couponDiscountTotal
        };
    }

    // ğŸ“Œ ë‹¤ìŒ ì£¼ì†Œ API í˜¸ì¶œ
    function execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function (data) {
                const addr = data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress;
                let extraAddr = '';
                if (data.userSelectedType === 'R') {
                    if (data.bname && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)) extraAddr += data.bname;
                    if (data.buildingName && data.apartment === 'Y')
                        extraAddr += (extraAddr ? ', ' : '') + data.buildingName;
                    if (extraAddr) extraAddr = ' (' + extraAddr + ')';
                }
                document.getElementById("postalCode").value = data.zonecode;
                document.getElementById("defaultAddress").value = addr;
                document.getElementById("extraAddress").value = extraAddr;
                document.getElementById("detailAddress").focus();
            }
        }).open();
    }

    // ğŸ“Œ ì£¼ë¬¸ì„œ ì „ì†¡ ë° ê²°ì œ ìš”ì²­
    function submitOrderForm() {
        const getVal = id => document.getElementById(id)?.value.trim();
        const requiredFields = ["ordererName", "ordererPhone", "ordererEmail", "recipientName", "recipientPhone", "postalCode", "defaultAddress", "detailAddress"];

        for (const id of requiredFields) {
            if (!getVal(id)) return alert("ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        }

        const selectedCoupons = Array.from(document.querySelectorAll('select[name="couponId"]'))
            .filter(select => !select.disabled && select.value);  // ì‹¤ì œë¡œ ì„ íƒëœ ì¿ í°ë§Œ í•„í„°ë§

        if (selectedCoupons.length > 1) {
            return alert("ì¿ í°ì€ í•œ ê°œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        }

        const userId = parseInt(getVal("userId"), 10);
        const preferredDate = window.getPreferredDeliveryDate();
        const items = [];

        document.querySelectorAll(".cart-item").forEach(item => {
            const packagingSelect = item.querySelector("select.packaging-select");
            const packagingValue = packagingSelect?.value;
            const packagingId = packagingValue ? parseInt(packagingValue) : null;

            const couponSelect = item.querySelector("select[name='couponId']");
            const couponValue = couponSelect?.value;
            const couponStoreId = (couponSelect && !couponSelect.disabled && couponValue)
                ? parseInt(couponValue)
                : null;

            items.push({
                bookId: parseInt(item.dataset.bookId),
                quantity: parseInt(item.dataset.quantity),
                price: parseInt(item.dataset.price),
                packagingId: packagingId,
                couponStoreId: couponStoreId
            });
        });

        const {productTotal, packagingTotal, couponDiscountTotal, shippingFee, paymentAmountBeforePoint} = getSummary();
        const usedPointAmount = usedPoint;
        const finalAmount = Math.max(paymentAmountBeforePoint - usedPointAmount, 0);

        if (finalAmount === 0) {
            openZeroPaymentModal(usedPointAmount, couponDiscountTotal);
            return;
        }

        const payload = {
            orderCreateRequest: {userId, ordererName: getVal("ordererName"), ordererPhone: getVal("ordererPhone")},
            shipmentCreateRequest: {
                preferredDeliveryDate: preferredDate,
                recipientName: getVal("recipientName"),
                recipientPhone: getVal("recipientPhone"),
                postalCode: parseInt(getVal("postalCode")),
                defaultAddress: getVal("defaultAddress"),
                detailAddress: getVal("detailAddress"),
                extraAddress: getVal("extraAddress"),
                shippingFee,
                shippingCode: null
            },
            createRequestList: items,
            discountAmount: couponDiscountTotal,
            usedPointAmount,
            paymentAmount: finalAmount
        };

        const toss = TossPayments("test_ck_ALnQvDd2VJ2jvnEdDeLnVMj7X41m");
        const contextPath = /*[[@{/}]]*/ '';

        fetch(`${contextPath}payments`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        })
            .then(async res => {
                const contentType = res.headers.get("Content-Type") || "";
                const isJson = contentType.includes("application/json");

                if (!res.ok) {
                    const errorBody = await res.text();
                    throw new Error(errorBody);
                }

                if (isJson) {
                    return res.json();
                } else {
                    return res.text(); // HTMLë¡œ ì˜¨ ê²½ìš° ì²˜ë¦¬
                }
            })
            .then(data => toss.requestPayment("ì¹´ë“œ", {
                amount: data.amount,
                orderId: data.orderId,
                orderName: data.orderName,
                customerName: data.customerName,
                successUrl: data.successUrl,
                failUrl: data.failUrl
            }))
            .catch(err => {
                console.log("error ë©”ì„¸ì§€ : " + err.message);
                const errorMessage = err.message || err;

                if (err.code === "USER_CANCEL") alert("ê²°ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.");
                else if (typeof errorMessage === "string" && errorMessage.includes("BOOK_INSUFFICIENT_STOCK")) {
                    alert("ë„ì„œ ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
                    window.location.href = `${contextPath}carts`;
                }
                else alert("ê²°ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    }

    // ğŸ“Œ 0ì› ê²°ì œì‹œ ëª¨ë‹¬ ì—´ê¸°
    function openZeroPaymentModal(usedPoint, discountAmount) {
        console.log('âœ… 0ì› ê²°ì œ ëª¨ë‹¬ ì—´ê¸° ì‹œë„');

        // ì‹ ê·œ (ì˜ìˆ˜ì¦ìš©)
        const productTotal = document.querySelector('[data-role="product-total"]').textContent;
        const shippingFee = document.querySelector('[data-role="shipping-fee"]').textContent;
        const packagingTotal = document.querySelector('[data-role="packaging-total"]').textContent;

        document.getElementById('receiptProductTotal').textContent = productTotal;
        document.getElementById('receiptShippingFee').textContent = shippingFee;
        document.getElementById('receiptPackagingTotal').textContent = packagingTotal;
        document.getElementById('receiptDiscountAmount').textContent = "-" + discountAmount.toLocaleString() + "ì›";
        document.getElementById('receiptUsedPoint').textContent = "-" + usedPoint.toLocaleString() + "P";

        document.getElementById('zeroPaymentModal').classList.remove('hidden');
    }

    // ğŸ“Œ 0ì› ê²°ì œì‹œ ëª¨ë‹¬ ë‹«ê¸°
    function closeZeroModal() {
        document.getElementById("zeroPaymentModal").classList.add("hidden");
    }

    // ğŸ“Œ 0ì› ê²°ì œì‹œ
    function submitZeroPayment() {
        const getVal = id => document.getElementById(id)?.value.trim();
        const userId = parseInt(getVal("userId"), 10);
        const preferredDate = window.getPreferredDeliveryDate();
        const items = [];

        document.querySelectorAll(".cart-item").forEach(item => {
            const packagingSelect = item.querySelector("select.packaging-select");
            const packagingValue = packagingSelect?.value;
            const packagingId = packagingValue ? parseInt(packagingValue) : null;

            const couponSelect = item.querySelector("select[name='couponId']");
            const couponValue = couponSelect?.value;
            const couponStoreId = (couponSelect && !couponSelect.disabled && couponValue)
                ? parseInt(couponValue)
                : null;

            items.push({
                bookId: parseInt(item.dataset.bookId),
                quantity: parseInt(item.dataset.quantity),
                price: parseInt(item.dataset.price),
                packagingId: packagingId,
                couponStoreId: couponStoreId
            });
        });

        const { shippingFee, couponDiscountTotal, packagingTotal, productTotal, paymentAmountBeforePoint } = getSummary();

        const payload = {
            orderCreateRequest: { userId, ordererName: getVal("ordererName"), ordererPhone: getVal("ordererPhone") },
            shipmentCreateRequest: {
                preferredDeliveryDate: preferredDate,
                recipientName: getVal("recipientName"),
                recipientPhone: getVal("recipientPhone"),
                postalCode: parseInt(getVal("postalCode")),
                defaultAddress: getVal("defaultAddress"),
                detailAddress: getVal("detailAddress"),
                extraAddress: getVal("extraAddress"),
                shippingFee,
                shippingCode: null
            },
            createRequestList: items,
            discountAmount: couponDiscountTotal,
            usedPointAmount: usedPoint,
            paymentAmount: 0 // ë°˜ë“œì‹œ 0ì›ìœ¼ë¡œ ì„¤ì •
        };

        const contextPath = /*[[@{/}]]*/ '';

        fetch(`${contextPath}payments/zero`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        })
            .then(async res => {
                const contentType = res.headers.get("Content-Type") || "";
                const isJson = contentType.includes("application/json");

                if (!res.ok) {
                    const errorBody = await res.text();
                    throw new Error(errorBody);
                }

                if (isJson) {
                    return res.json();
                } else {
                    return res.text(); // HTMLë¡œ ì˜¨ ê²½ìš° ì²˜ë¦¬
                }
            })
            .then(html => {
                // ê²°ì œ ì„±ê³µ í˜ì´ì§€ HTMLë¡œ ì „í™˜
                document.open();
                document.write(html);
                document.close();
            })
            .catch(err => {
                const errorMessage = err.message || err;
                if (typeof errorMessage === "string" && errorMessage.includes("BOOK_INSUFFICIENT_STOCK")) {
                    alert("ë„ì„œ ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
                    window.location.href = `${contextPath}carts`;
                }  else {
                    alert("0ì› ê²°ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    console.error(err);
                }

            });
    }
</script>
