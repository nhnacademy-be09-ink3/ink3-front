<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ink3</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/output.css(v=${#dates.createNow().getTime()})}">
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100">
<div th:replace="~{layout/fragments/header :: headerFragment}"></div>
<main class="container max-w-[1600px] mx-auto px-4 py-8">
    <!-- ë¹„íšŒì› ì•ˆë‚´ ë©”ì‹œì§€ -->
    <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded mb-6">
        <p class="font-medium">ë¹„íšŒì› ì£¼ë¬¸ ì•ˆë‚´</p>
        <p class="text-sm mt-1">
            ë¡œê·¸ì¸ ì—†ì´ ì£¼ë¬¸ì„ ì§„í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤. <strong class="text-yellow-700">ì£¼ë¬¸ í™•ì¸ì€ ì´ë©”ì¼ê³¼ ì£¼ë¬¸ë²ˆí˜¸</strong>ë¡œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
            â€» ë¹„íšŒì› ì£¼ë¬¸ì˜ ê²½ìš° êµí™˜/ë°˜í’ˆì´ ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
    </div>
    <div class="flex flex-col lg:flex-row gap-10">

        <!-- ì™¼ìª½: ì…ë ¥ -->
        <div class="w-full lg:w-[70%] bg-white p-8 rounded-xl shadow">
            <!-- ì£¼ë¬¸ ìƒí’ˆ ëª©ë¡ -->
            <section class="mb-8">
                <h2 class="text-2xl font-semibold mb-4">ì£¼ë¬¸ ìƒí’ˆ</h2>
                <!-- ì£¼ë¬¸ ìƒí’ˆ ì¹´ë“œ: ê°€ë¡œ ì •ë ¬ -->
                <div th:each="item : ${cart}"
                     class="cart-item bg-white p-4 rounded-xl shadow text-sm flex items-center gap-6 mb-4"
                     th:attr="data-book-id=${item.bookId}, data-price=${item.book.saleBookPrice}, data-quantity=${item.quantity}">

                    <!-- ì´ë¯¸ì§€ -->
                    <div class="w-16 flex-shrink-0">
                        <img th:src="${item.book.thumbnailUrl}" alt="ë„ì„œ ì´ë¯¸ì§€"
                             class="w-full h-auto rounded border border-gray-200">
                    </div>

                    <!-- ìƒí’ˆëª… -->
                    <div class="min-w-[130px]">
                        <div class="text-gray-500 text-xs">ìƒí’ˆëª…</div>
                        <div class="font-medium text-gray-800" th:text="${item.book.bookTitle}">ë„ì„œ ì œëª©</div>
                    </div>

                    <!-- ì •ê°€ -->
                    <div class="min-w-[70px]">
                        <div class="text-gray-500 text-xs">ì •ê°€</div>
                        <div th:text="${#numbers.formatInteger(item.book.originalBookPrice, 0, 'COMMA') + 'ì›'}">ì •ê°€</div>
                    </div>

                    <!-- ìˆ˜ëŸ‰ -->
                    <div class="min-w-[60px]">
                        <div class="text-gray-500 text-xs">ìˆ˜ëŸ‰</div>
                        <div th:text="${item.quantity + 'ê°œ'}">0ê°œ</div>
                    </div>

                    <!-- í• ì¸ê¸ˆì•¡ -->
                    <div class="min-w-[90px]">
                        <div class="text-gray-500 text-xs">í• ì¸ê¸ˆì•¡</div>
                        <div class="text-red-600 font-semibold"
                             th:text="${#numbers.formatInteger(item.book.saleBookPrice, 0, 'COMMA') + 'ì›'}">
                            í• ì¸ê¸ˆì•¡
                        </div>
                        <div class="text-xs text-red-500"
                             th:if="${item.book.bookDiscountRate != null}"
                             th:text="|(${item.book.bookDiscountRate}% â†“)|">
                        </div>                    </div>

                    <!-- í•©ê³„ -->
                    <div class="min-w-[90px] text-right">
                        <div class="text-gray-500 text-xs">í•©ê³„</div>
                        <div class="text-base font-bold text-gray-900"
                             th:text="${#numbers.formatInteger(item.book.saleBookPrice * item.quantity, 0, 'COMMA') + 'ì›'}">
                            í•©ê³„
                        </div>
                    </div>

                    <!-- í¬ì¥ì§€ ì„ íƒ -->
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium text-gray-700 whitespace-nowrap w-[90px]">í¬ì¥ì§€ ì„ íƒ</label>
                        <select class="packaging-select ink-input-field w-full sm:w-[240px]"
                                th:disabled="${!item.book.isPackable}"
                                th:classappend="${!item.book.isPackable} ? ' bg-gray-100 text-gray-400 cursor-not-allowed'">
                            <option th:if="${item.book.isPackable}" value="">í¬ì¥ì§€ ì„ íƒ ì•ˆ í•¨</option>
                            <option th:unless="${item.book.isPackable}" disabled selected>í¬ì¥ì§€ ì„ íƒ ë¶ˆê°€ ìƒí’ˆ</option>
                            <option th:each="p : ${packagings}"
                                    th:if="${item.book.isPackable}"
                                    th:value="${p.id}"
                                    th:text="${p.name + ' (' + #numbers.formatInteger(p.price, 0, 'COMMA') + 'ì›)'}"
                                    th:attr="data-price=${p.price}"
                                    th:disabled="${!p.isAvailable}">
                            </option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- ì£¼ë¬¸ì ì •ë³´ -->
            <section class="mb-8">
                <h2 class="text-2xl font-semibold mt-10 mb-4">ì£¼ë¬¸ì ì •ë³´</h2>
                <div class="bg-gray-50 p-4 rounded-lg shadow space-y-6 text-sm">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-1 text-sm font-medium text-gray-700">ì´ë¦„</label>
                            <input type="text" class="ink-input-field w-full" id="ordererName" placeholder="í™ê¸¸ë™">
                        </div>
                        <div>
                            <label class="block mb-1 text-sm font-medium text-gray-700">ì—°ë½ì²˜</label>
                            <input type="text" class="ink-input-field w-full" id="ordererPhone" placeholder="010-9876-5432">
                        </div>
                    </div>
                    <div>
                        <label class="block mb-1 text-sm font-medium text-gray-700">ì´ë©”ì¼</label>
                        <input type="email" class="ink-input-field w-full" id="ordererEmail"
                               placeholder="example@email.com">
                        <small class="text-gray-500 text-xs mt-1 block">
                               â€» ì£¼ë¬¸ í™•ì¸ ë©”ì¼ì´ ë°œì†¡ë˜ë©°, ì´í›„ <strong>ì£¼ë¬¸ ì¡°íšŒ ì‹œ ì¸ì¦ìš©</strong>ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
                        </small>
                    </div>
                </div>
            </section>


            <!-- ë°°ì†¡ì§€ ì •ë³´ -->
            <section class="mb-8">
                <!-- ë°°ì†¡ì§€ ì •ë³´ -->
                <section class="mb-8">
                    <h2 class="text-2xl font-semibold mt-10 mb-4">ë°°ì†¡ì§€ ì •ë³´</h2>

                    <!-- ì£¼ì†Œ ì…ë ¥ í•„ë“œ -->
                    <div class="bg-gray-50 p-4 rounded-lg shadow space-y-6 text-sm">

                        <!-- ìˆ˜ë ¹ì¸ & ì—°ë½ì²˜ -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700">ìˆ˜ë ¹ì¸</label>
                                <input type="text" class="ink-input-field w-full" id="recipientName" placeholder="ìˆ˜ë ¹ì¸">
                            </div>
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700">ì—°ë½ì²˜</label>
                                <input type="text" class="ink-input-field w-full" id="recipientPhone"  placeholder="010-9876-5432">
                            </div>
                        </div>

                        <!-- ì£¼ì†Œ -->
                        <div class="flex flex-col gap-3">
                            <label class="block mb-1 text-sm font-medium text-gray-700">ë°°ì†¡ ì£¼ì†Œ</label>
                            <div class="flex flex-col space-y-[16px]">
                                <!-- ìš°í¸ë²ˆí˜¸ + ë²„íŠ¼ -->
                                <div class="flex gap-2">
                                    <input type="text" id="postalCode" class="ink-input-field w-[30%]"
                                           placeholder="ìš°í¸ë²ˆí˜¸" readonly>
                                    <button type="button" onclick="execDaumPostcode()"
                                            class="ink-btn-primary text-sm px-4 py-2 h-full">
                                        ìš°í¸ë²ˆí˜¸ ì°¾ê¸°
                                    </button>
                                </div>

                                <!-- ë„ë¡œëª… ì£¼ì†Œ -->
                                <input type="text" id="defaultAddress" class="ink-input-field w-full"
                                       placeholder="ë„ë¡œëª… ì£¼ì†Œ" readonly>

                                <!-- ìƒì„¸ ì£¼ì†Œ -->
                                <input type="text" id="detailAddress" class="ink-input-field w-full"
                                       placeholder="ìƒì„¸ ì£¼ì†Œ ì…ë ¥">

                                <!-- ì°¸ê³  ì£¼ì†Œ -->
                                <input type="text" id="extraAddress" class="ink-input-field w-full"
                                       placeholder="ì°¸ê³  ì£¼ì†Œ ì…ë ¥">
                            </div>
                        </div>

                        <!-- í¬ë§ ë°°ì†¡ì¼ -->
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-700">í¬ë§ ë°°ì†¡ì¼</label>

                            <!-- ê¸°ë³¸ ë°°ì†¡ì¼ ì•ˆë‚´ -->
                            <div class="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-2 rounded-md text-sm mb-4">
                                ê¸°ë³¸ ë°°ì†¡ ì˜ˆì •ì¼ì€ <strong id="defaultDeliveryDate">2025-06-02</strong> ì…ë‹ˆë‹¤.
                            </div>

                            <!-- ë°°ì†¡ì¼ ì§€ì • ìŠ¤ìœ„ì¹˜ -->
                            <div class="flex items-center gap-4 mb-4">
                                <label for="enablePreferredDate" class="inline-flex items-center cursor-pointer">
                                    <span class="mr-3 text-sm text-gray-700">ë°°ì†¡ì¼ ì§€ì •</span>
                                    <div class="relative">
                                        <input type="checkbox" id="enablePreferredDate" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-300 rounded-full peer peer-checked:bg-indigo-500 transition-all"></div>
                                        <div class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow peer-checked:translate-x-full transition-transform"></div>
                                    </div>
                                </label>
                            </div>

                            <!-- ë‚ ì§œ ì„ íƒ input -->
                            <div>
                                <input type="date" id="preferredDeliveryDateInput"
                                       class="ink-input-field w-full sm:w-[250px] bg-white text-gray-800 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                                       disabled
                                       min="2025-06-02"
                                >
                            </div>
                        </div>

                    </div>
                </section>
            </section>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ìš”ì•½ -->
        <div class="w-full lg:w-[30%]">
            <div class="sticky top-6 bg-white p-6 rounded-xl shadow min-h-[75vh] flex flex-col justify-between border border-gray-200">
                <div>
                    <h2 class="text-xl font-bold border-b pb-2 mb-4">ì£¼ë¬¸ ìš”ì•½</h2>
                    <div class="space-y-2 text-sm mb-6">
                        <!-- ìƒí’ˆë³„ ìš”ì•½ ë°˜ë³µ ë Œë”ë§ -->
                        <div th:each="item : ${cart}" class="flex justify-between">
                            <span th:text="${item.book.bookTitle}">ë„ì„œëª…</span>
                            <span th:text="${item.quantity + 'ê°œ / ' + (#numbers.formatInteger(item.book.saleBookPrice * item.quantity, 0, 'COMMA') + 'ì›')}">0ê°œ / 0ì›</span>
                        </div>
                    </div>

                    <h2 class="text-xl font-bold border-b pb-2 mb-4">ê²°ì œ ë‚´ì—­</h2>
                    <div class="space-y-2 text-sm">
                        <!-- ìƒí’ˆ ì´ì•¡ -->
                        <div class="flex justify-between">
                            <span>ìƒí’ˆ ì´ì•¡</span>
                            <span><span data-role="product-total">0ì›</span></span>
                        </div>

                        <!-- ë°°ì†¡ë¹„ -->
                        <div class="flex justify-between">
                            <span>ë°°ì†¡ë¹„</span>
                            <span><span data-role="shipping-fee">3,000ì›</span></span>
                        </div>
                        <script th:inline="javascript">
                            const SHIPPING_POLICY = {
                                threshold: [[${activeShippingPolicy.threshold}]],
                                fee: [[${activeShippingPolicy.fee}]]
                            };
                        </script>

                        <!-- í¬ì¥ì§€ ë¹„ìš© -->
                        <div class="flex justify-between">
                            <span>í¬ì¥ì§€ ë¹„ìš©</span>
                            <span><span data-role="packaging-total">0ì›</span></span>
                        </div>

                        <!-- ìµœì¢… ê²°ì œ ê¸ˆì•¡ -->
                        <div class="flex justify-between font-bold text-base">
                            <span>ìµœì¢… ê²°ì œ</span>
                            <span><span data-role="final-total">0ì›</span></span>
                        </div>
                    </div>
                </div>
                <div class="text-xs text-gray-500 text-center mt-4">
                      â€» ì£¼ë¬¸ í›„ <strong>ì´ë©”ì¼ê³¼ ì£¼ë¬¸ë²ˆí˜¸</strong>ë¡œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
                <button type="button" onclick="submitOrderForm('TOSS')" class="ink-btn-primary mt-8 w-full text-base py-2">
                    í† ìŠ¤ë¡œ ê²°ì œí•˜ê¸°
                </button>

            </div>
        </div>
    </div>
</main>
<div th:replace="~{layout/fragments/footer :: footerFragment}"></div>
</body>
</html>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", () => {
        initDeliveryDate(); // í¬ë§ ë°°ì†¡ì¼ ì§€ì •
        initAutoHyphen(["ordererPhone", "recipientPhone"]); // ì „í™”ë²ˆí˜¸ í¬ë§·
        initPackagingSelect(); // í¬ì¥ì§€ ì„ íƒ
        updateSummary(); // ê²°ì œ ìš”ì•½ ì—…ë°ì´íŠ¸
    });

    /** --------------------------------------- ìœ í‹¸ --------------------------------------------- */

    // ğŸ“Œ ì „í™”ë²ˆí˜¸ í•˜ì´í”ˆ ìë™
    function initAutoHyphen(ids) {
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener("input", (e) => {
                const num = e.target.value.replace(/\D/g, "");
                if (num.startsWith("02")) {
                    e.target.value = num.replace(/(\d{2})(\d{3,4})(\d{4})/, "$1-$2-$3");
                } else {
                    e.target.value = num.replace(/(\d{3})(\d{3,4})(\d{4})/, "$1-$2-$3");
                }
            });
        });
    }

    // ğŸ“Œ í†µí™” í¬ë§·
    function formatCurrency(num) {
        return new Intl.NumberFormat('ko-KR').format(num) + 'ì›';
    }

    /** --------------------------------------- ë°°ì†¡ì§€ ì…ë ¥  --------------------------------------------- */

    // ğŸ“Œ ë‹¤ìŒ ì£¼ì†Œ API
    function execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function (data) {
                let addr = data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress;
                let extraAddr = '';

                if (data.userSelectedType === 'R') {
                    if (data.bname && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)) {
                        extraAddr += data.bname;
                    }
                    if (data.buildingName && data.apartment === 'Y') {
                        extraAddr += (extraAddr ? ', ' : '') + data.buildingName;
                    }
                    if (extraAddr) {
                        extraAddr = ' (' + extraAddr + ')';
                    }
                }

                document.getElementById("postalCode").value = data.zonecode;
                document.getElementById("defaultAddress").value = addr;
                document.getElementById("extraAddress").value = extraAddr;
                document.getElementById("detailAddress").focus();
            }
        }).open();
    }

    // ğŸ“Œ í¬ë§ ë°°ì†¡ì¼ ì´ˆê¸°í™”
    function initDeliveryDate() {
        const checkbox = document.getElementById("enablePreferredDate");
        const dateInput = document.getElementById("preferredDeliveryDateInput");

        const defaultDate = new Date();
        defaultDate.setDate(defaultDate.getDate() + 2);
        const formatted = defaultDate.toISOString().split('T')[0];

        document.getElementById("defaultDeliveryDate").textContent = formatted;
        dateInput.min = formatted;
        dateInput.value = formatted;

        checkbox?.addEventListener("change", () => {
            dateInput.disabled = !checkbox.checked;
        });

        window.getPreferredDeliveryDate = () => checkbox?.checked ? dateInput?.value : formatted;
    }

    /** --------------------------------------- í¬ì¥ì§€ ì„ íƒ --------------------------------------------- */

    // ğŸ“Œ í¬ì¥ì§€ ì„ íƒ ì´ë²¤íŠ¸
    function initPackagingSelect() {
        document.querySelectorAll('select.packaging-select').forEach(select =>
            select.addEventListener('change', updateSummary)
        );
    }

    /** --------------------------------------- ê²°ì œ ìš”ì•½ í™”ë©´ ì—…ë°ì´íŠ¸ --------------------------------------------- */

    // ğŸ“Œ ê²°ì œ ìš”ì•½ ê³„ì‚°
    function updateSummary() {
        let productTotal = 0, packagingTotal = 0;

        document.querySelectorAll('.cart-item').forEach(item => {
            const price = parseInt(item.dataset.price || '0', 10);
            const quantity = parseInt(item.dataset.quantity || '0', 10);
            productTotal += price * quantity;

            const select = item.querySelector('select.packaging-select');
            if (select && !select.disabled) {
                const selectedOption = select.selectedOptions[0];
                const packagingPrice = parseInt(selectedOption?.dataset.price || '0', 10);
                packagingTotal += packagingPrice;
            }
        });

        const shippingFee = productTotal >= SHIPPING_POLICY.threshold ? 0 : SHIPPING_POLICY.fee;
        const finalAmount = Math.max(productTotal + packagingTotal + shippingFee, 0);

        document.querySelector('[data-role="product-total"]').textContent = formatCurrency(productTotal);
        document.querySelector('[data-role="packaging-total"]').textContent = formatCurrency(packagingTotal);
        document.querySelector('[data-role="shipping-fee"]').textContent = formatCurrency(shippingFee);
        document.querySelector('[data-role="final-total"]').textContent = formatCurrency(finalAmount);
    }

    /** --------------------------------------- ê²°ì œ ìš”ì²­ --------------------------------------------- */
    // ğŸ“Œ ì£¼ë¬¸ ì œì¶œ
    function submitOrderForm(requestPaymentType) {
        const requiredFields = [
            "ordererName", "ordererPhone", "ordererEmail",
            "recipientName", "recipientPhone",
            "postalCode", "defaultAddress", "detailAddress"
        ];

        for (const id of requiredFields) {
            if (!document.getElementById(id)?.value.trim()) {
                alert("ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
        }

        const { payload, amount, paymentType } = createGuestOrderPayload(requestPaymentType);

        switch (paymentType) {
            case "TOSS":
                tossRequestPayment(payload);
                break;
            default:
                console.error("ì§€ì›í•˜ì§€ ì•ŠëŠ” ê²°ì œ ë°©ì‹ì…ë‹ˆë‹¤:", paymentType);
        }
    }

    function createGuestOrderPayload(initialType) {
        const getVal = id => document.getElementById(id)?.value.trim();
        const preferredDate = window.getPreferredDeliveryDate();

        const items = [];
        let productTotal = 0;
        let packagingTotal = 0;

        document.querySelectorAll(".cart-item").forEach(item => {
            const price = parseInt(item.dataset.price);
            const quantity = parseInt(item.dataset.quantity);
            productTotal += price * quantity;

            const packagingSelect = item.querySelector("select.packaging-select");
            const packagingId = (packagingSelect && !packagingSelect.disabled && packagingSelect.value)
                ? parseInt(packagingSelect.value)
                : null;

            const packagingPrice = (packagingSelect && !packagingSelect.disabled)
                ? parseInt(packagingSelect.selectedOptions[0]?.dataset.price || "0")
                : 0;

            packagingTotal += packagingPrice;

            items.push({
                bookId: parseInt(item.dataset.bookId),
                packagingId,
                couponStoreId: null,
                price,
                quantity
            });
        });

        const shippingFee = productTotal >= SHIPPING_POLICY.threshold ? 0 : SHIPPING_POLICY.fee;
        const finalAmount = productTotal + packagingTotal + shippingFee;

        const paymentType = finalAmount === 0 ? "POINT" : initialType;

        return {
            payload: {
                guestCreateRequest: { email: getVal("ordererEmail") },
                guestOrderCreateRequest: {
                    ordererName: getVal("ordererName"),
                    ordererPhone: getVal("ordererPhone")
                },
                shipmentCreateRequest: {
                    preferredDeliveryDate: preferredDate,
                    recipientName: getVal("recipientName"),
                    recipientPhone: getVal("recipientPhone"),
                    postalCode: parseInt(getVal("postalCode")),
                    defaultAddress: getVal("defaultAddress"),
                    detailAddress: getVal("detailAddress"),
                    extraAddress: getVal("extraAddress"),
                    shippingFee,
                    shippingCode: null
                },
                createRequestList: items,
                paymentAmount: finalAmount,
                paymentType
            },
            amount: finalAmount,
            paymentType
        };
    }

    /** --------------------------------------- í˜ì´ë¨¼íŠ¸ ê²°ì œ í™•ì¥  --------------------------------------------- */

    /** --------------------------------------- í† ìŠ¤ í˜ì´ë¨¼íŠ¸ ê²°ì œ --------------------------------------------- */
    function tossRequestPayment(payload) {
        const toss = TossPayments("test_ck_ALnQvDd2VJ2jvnEdDeLnVMj7X41m");
        const contextPath = /*[[@{/}]]*/ '';

        fetch(`${contextPath}guest-payment`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        })
            .then(async res => {
                const contentType = res.headers.get("Content-Type") || "";
                const isJson = contentType.includes("application/json");

                if (!res.ok) {
                    const errorBody = await res.text();
                    throw new Error(errorBody);
                }

                return isJson ? res.json() : res.text();
            })
            .then(data => toss.requestPayment("ì¹´ë“œ", {
                amount: data.amount,
                orderId: data.orderId,
                orderName: data.orderName,
                customerName: data.customerName,
                successUrl: data.successUrl,
                failUrl: data.failUrl
            }))
            .catch(handlePaymentError);
    }


    /** --------------------------------------- ê²°ì œ ì—ëŸ¬ ì²˜ë¦¬ --------------------------------------------- */
// ğŸ“Œ ê³µí†µ ì—ëŸ¬ ì²˜ë¦¬
    function handlePaymentError(err) {
        console.error("ğŸ”¥ ê²°ì œ ì—ëŸ¬ ë©”ì‹œì§€:", err.message || err);
        const errorMessage = err.message || "";
        const contextPath = /*[[@{/}]]*/ '';

        try {
            const outer = JSON.parse(errorMessage);
            const traceMatch = outer.trace?.match(/\[({.*?})\]/);
            if (traceMatch && traceMatch[1]) {
                const innerError = JSON.parse(traceMatch[1]);

                // â—ë„ì„œ ì¬ê³  ë¶€ì¡±
                if (innerError.message === "BOOK_INSUFFICIENT_STOCK.") {
                    alert(innerError.data || "ë„ì„œ ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
                    window.location.href = `${contextPath}carts`;
                    return;
                }

                // â—ê¸°íƒ€ ì„œë²„ ì •ì˜ ì—ëŸ¬
                if (innerError.message && innerError.data) {
                    alert(innerError.data);
                    return;
                }
            }
        } catch (e) {
            console.warn("âš ï¸ ì—ëŸ¬ JSON íŒŒì‹± ì‹¤íŒ¨:", e);
        }

        if (err.code === "USER_CANCEL") {
            alert("ê²°ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.");
        } else {
            alert("ê²°ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

</script>
