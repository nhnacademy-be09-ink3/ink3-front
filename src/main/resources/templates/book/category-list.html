<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ink3</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/output.css}" />
</head>
<body class="bg-gray-100">
<div th:replace="~{layout/fragments/header :: headerFragment}"></div>

<main class="px-6 py-8 bg-gray-100">
    <div class="flex max-w-7xl mx-auto gap-6">
        <!-- ÏÇ¨Ïù¥Îìú Î©îÎâ¥ -->
        <aside class="w-40 self-start bg-white rounded-lg shadow p-4 relative overflow-visible">
            <h2 class="text-lg font-bold mb-4">üìö Ïπ¥ÌÖåÍ≥†Î¶¨</h2>
            <ul id="category-menu" class="space-y-2"></ul>
        </aside>

        <!-- ÎèÑÏÑú Î¶¨Ïä§Ìä∏ -->
        <div class="flex-1">
            <div class="flex justify-between items-center mb-6">
                <h1 id="search-title" class="text-2xl font-bold text-gray-800">
                    üìÇ <span id="category-name"></span>
                </h1>

                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <label for="sortSelect" class="text-sm text-gray-700">Ï†ïÎ†¨:</label>
                        <select id="sortSelect" class="border border-gray-300 rounded px-2 py-1 text-sm">
                            <option value="title,asc">Ï†úÎ™©Ïàú</option>
                            <option value="originalPrice,asc">Í∞ÄÍ≤© ÎÇÆÏùÄÏàú</option>
                            <option value="originalPrice,desc">Í∞ÄÍ≤© ÎÜíÏùÄÏàú</option>
                            <option value="publishedAt,desc">Ï∂úÍ∞ÑÏùº ÏµúÏã†Ïàú</option>
                        </select>
                    </div>

                    <div class="flex items-center gap-2">
                        <label for="itemsPerPage" class="text-sm text-gray-700">ÌëúÏãú Í∞úÏàò:</label>
                        <select id="itemsPerPage" class="border border-gray-300 rounded px-2 py-1 text-sm">
                            <option value="5">5Í∞ú</option>
                            <option value="10" selected>10Í∞ú</option>
                            <option value="15">15Í∞ú</option>
                            <option value="20">20Í∞ú</option>
                            <option value="25">25Í∞ú</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="book-list" class="flex flex-col gap-6 px-4">
                <div th:each="book : ${bookList}" class="flex bg-white rounded-xl shadow hover:shadow-md w-full max-w-5xl mx-auto transition p-4">
                    <a th:href="@{|/books/${book.id}|}" class="w-[130px] h-[190px] flex-shrink-0 mr-6 block">
                        <img th:src="${book.thumbnailUrl}" th:alt="${book.title}" class="w-full h-full object-cover rounded-md" />
                    </a>
                    <div class="flex flex-col justify-between flex-1">
                        <div>
                            <a th:href="@{|/books/${book.id}|}" class="text-lg font-bold text-gray-900 mb-1 hover:underline block" th:text="${book.title}">Ï†úÎ™©</a>
                            <div class="text-sm text-gray-600 mb-1">
                                <span th:if="${#lists.isEmpty(book.authors)}">Ï†ÄÏûê ÏóÜÏùå</span>
                                    <span th:if="${!#lists.isEmpty(book.authors)}">
                                        <th:block th:each="author, iterStat : ${book.authors}">
                                            <span th:text="${author.authorName + ' (' + author.role + ')'}"></span>
                                            <th:block th:if="${!iterStat.last}">, </th:block>
                                        </th:block>
                                    </span>
                                <span th:text="' ¬∑ ' + ${book.publisherName} + ' | ' + ${book.publishedAt}"></span>
                            </div>
                            <a th:href="@{|/books/${book.id}|}" class="text-base font-semibold text-red-600 mb-1 block">
                                <span th:text="${#numbers.formatInteger(book.salePrice, 3, 'COMMA')} + 'Ïõê'">Í∞ÄÍ≤©</span>
                                <span class="title-font font-medium bg-red-100 text-red-600 text-sm font-bold px-2 py-1 rounded-md" th:text="${book.discountRate + '%'}"></span>
                            </a>
                            <a th:href="@{|/books/${book.id}|}" class="text-sm text-gray-400 line-through block" th:text="${#numbers.formatInteger(book.originalPrice, 3, 'COMMA')} + 'Ïõê'">Ï†ïÍ∞Ä</a>
                            <a th:href="@{|/books/${book.id}|}" class="text-sm mt-2 text-gray-700 line-clamp-2 block"
                               th:text="${#strings.length(book.description) > 100 ? #strings.abbreviate(book.description, 100) : book.description}">
                                ÏÑ§Î™Ö
                            </a>
                        </div>
                    </div>
                    <div class="flex flex-col items-end w-40 flex-shrink-0">
                        <div class="flex items-center justify-between border border-gray-300 rounded px-2 py-1 w-full mb-3">
                            <button type="button" class="text-gray-700 px-2" th:onclick="'changeQty(' + ${book.id} + ', -1)'">‚àí</button>
                            <input type="text" th:id="'qty-' + ${book.id}" class="w-10 text-center outline-none bg-transparent px-2" value="1" maxlength="3" onkeyup="checkNumeric(this)" title="ÏàòÎüâÏÑ§Ï†ï" />
                            <button type="button" class="text-gray-700 px-2" th:onclick="'changeQty(' + ${book.id} + ', 1)'">Ôºã</button>
                        </div>
                        <div class="flex flex-col gap-3 w-full">
                            <button type="button" class="ink-btn-primary text-sm px-4 py-2 w-full" th:onclick="'addToCart(' + ${book.id} + ', document.getElementById(\'qty-' + ${book.id} + '\').value)'">Ïπ¥Ìä∏Ïóê Îã¥Í∏∞</button>
                            <button type="button" class="ink-btn-primary text-sm px-4 py-2 w-full mb-2" th:onclick="'orderNow(' + ${book.id} + ', document.getElementById(\'qty-' + ${book.id} + '\').value)'">Î∞îÎ°úÍµ¨Îß§</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="pagination" class="flex justify-center items-center gap-2 mt-6"></div>

            <!-- ‚úÖ Ï∂îÏ≤ú ÎèÑÏÑú Í≥†Ï†ï -->
            <section id="recommended-section" class="py-10 mt-16">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">üìñ Ïù¥Îü∞ Ï±ÖÏùÄ Ïñ¥Îñ†Ïã†Í∞ÄÏöî?</h2>
                <div id="recommended-books" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 justify-items-center"></div>
            </section>
        </div>
    </div>
</main>

<div th:replace="~{layout/fragments/footer :: footerFragment}"></div>

<script th:inline="javascript">

    let currentSort = 'title,asc';
    const isLoggedIn = [[${isLoggedIn}]];
    const contextPath = /*[[@{/}]]*/ "/";

    function goToCategory(name) {
        const encoded = encodeURIComponent(name);
        location.href = `${contextPath}books/category?name=${encoded}`;
    }

    function orderNow(bookId, quantity) {
        const form = document.createElement('form');
        form.method = 'get';
        form.action = `${contextPath}order-form/from-book/${bookId}`;

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'quantity';
        input.value = quantity;

        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }

    document.addEventListener('DOMContentLoaded', () => {
        const bookList = document.getElementById('book-list');
        const paginationEl = document.getElementById('pagination');
        const recommendedBooks = document.getElementById('recommended-books');
        const itemsPerPageSelect = document.getElementById('itemsPerPage');

        let currentPage = 1;
        let itemsPerPage = parseInt(itemsPerPageSelect.value);

        // ‚úÖ Ïπ¥ÌÖåÍ≥†Î¶¨Î™Ö Ï∂îÏ∂ú
        const urlParams = new URLSearchParams(window.location.search);
        const categoryName = urlParams.get('name') || '';
        document.getElementById('category-name').innerText = categoryName;

        fetchBooks();

        // ‚úÖ ÎèÑÏÑú Î†åÎçîÎßÅ
        fetch(`${window.api.gatewayBaseUrl}/shop/categories`)
            .then(res => res.json())
            .then(data => {
                const tree = buildCategoryTree(data.data.content);
                const rootNode = tree.find(cat => cat.name === 'ROOT');
                const filteredTree = rootNode?.children || [];
                renderCategoryMenu(filteredTree, document.getElementById('category-menu'));
            })
            .catch(err => console.error('Ïπ¥ÌÖåÍ≥†Î¶¨ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:', err));


        const renderBooks = (books) => {
            bookList.innerHTML = '';
            books.forEach(book => {

                const authors = book.authors && book.authors.length > 0
                    ? book.authors.map(a => `${a.authorName} (${a.role})`).join(', ')
                    : 'Ï†ÄÏûê ÏóÜÏùå';

                const div = document.createElement('div');
                div.className = 'flex bg-white rounded-xl shadow hover:shadow-md w-full max-w-5xl mx-auto transition p-4';

                div.innerHTML = `
                    <a href="${contextPath}books/${book.id}" class="w-[130px] h-[190px] flex-shrink-0 mr-6 block">
                        <img src="${book.thumbnailUrl}" alt="${book.title}" class="w-full h-full object-cover rounded-md" />
                    </a>
                    <div class="flex flex-col justify-between flex-1">
                        <div>
                            <a href="${contextPath}books/${book.id}" class="text-lg font-bold text-gray-900 mb-1 hover:underline block">
                                ${book.title}
                            </a>
                            <a href="${contextPath}books/${book.id}" class="text-sm text-gray-600 mb-1 block">
                                ${authors} ¬∑ ${book.publisherName} | ${book.publishedAt}
                            </a>
                            <a href="${contextPath}books/${book.id}" class="text-base font-semibold text-red-600 mb-1 block">
                                ${book.salePrice.toLocaleString()}Ïõê <span class="title-font font-medium bg-red-100 text-red-600 text-sm font-bold px-2 py-1 rounded-md">${book.discountRate}%</span>
                            </a>
                            <a href="${contextPath}books/${book.id}" class="text-sm text-gray-400 line-through block">
                                ${book.originalPrice.toLocaleString()}Ïõê
                            </a>
                            <a href="${contextPath}books/${book.id}" class="text-sm text-yellow-600 font-semibold flex items-center gap-1 mt-1">
                                <span>‚≠ê</span>
                                <span class="average-rating" data-book-id="${book.id}">-</span>
                                <span class="text-gray-500 ml-1">(Î¶¨Î∑∞ <span class="review-count">-</span>Í∞ú)</span>
                            </a>
                            <a href="${contextPath}books/${book.id}" class="text-sm mt-2 text-gray-700 block">
                                ${book.description && book.description.length > 100
                                                ? book.description.substring(0, 100) + '...'
                                                : book.description}
                            </a>
                        </div>
                    </div>
            <div class="flex flex-col items-end w-40 flex-shrink-0">
                <div class="flex items-center justify-between border border-gray-300 rounded px-2 py-1 w-full mb-3">
                    <button onclick="changeQty(${book.id}, -1)" class="text-gray-700 px-2">‚àí</button>
                    <input
                          type="text"
                          id="qty-${book.id}"
                          class="w-10 text-center outline-none bg-transparent px-2"
                          value="1"
                          maxlength="3"
                          onkeyup="checkNumeric(this)"
                          title="ÏàòÎüâÏÑ§Ï†ï"
                        />
                    <button onclick="changeQty(${book.id}, 1)" class="text-gray-700 px-2">Ôºã</button>
                </div>
                <div class="flex flex-col gap-3 w-full">
                    <button class="ink-btn-primary text-sm px-4 py-2 w-full"
                        onclick="addToCart(${book.id}, document.getElementById('qty-${book.id}').value)">
                        Ïπ¥Ìä∏Ïóê Îã¥Í∏∞
                    </button>
                   <button
                      class="ink-btn-primary text-sm px-4 py-2 w-full mb-2"
                      onclick="orderNow(${book.id}, document.getElementById('qty-${book.id}').value)">
                      Î∞îÎ°úÍµ¨Îß§
                    </button>
                </div>
            </div>
        `;
                fetchReviewData(book.id).then(review => {
                    console.log('üìä bookId:', book.id, 'Î¶¨Î∑∞:', review);
                    const ratingEl = div.querySelector('.average-rating');
                    const countEl = div.querySelector('.review-count');

                    if (ratingEl) ratingEl.innerText = review.average?.toFixed(1) ?? '-';
                    if (countEl) countEl.innerText = review.count;
                });
                bookList.appendChild(div);
            });
        }
        // ‚úÖ ÌéòÏù¥Ïßï Î†åÎçîÎßÅ



        const renderPagination = (totalItems) => {
            paginationEl.innerHTML = '';
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const groupSize = 10;
            const currentGroup = Math.floor((currentPage - 1) / groupSize);
            const startPage = currentGroup * groupSize + 1;
            const endPage = Math.min(startPage + groupSize - 1, totalPages);

            const createBtn = (label, page, isActive = false) => {
                const btn = document.createElement('button');
                btn.textContent = label;
                btn.className = `px-3 py-1 border rounded ${isActive ? 'bg-ink-primary text-white' : 'hover:bg-gray-100'}`;
                btn.disabled = page < 1 || page > totalPages;

                btn.addEventListener('click', () => {
                    currentPage = page;
                    fetchBooks();
                    const scrollTarget = document.getElementById('search-title');
                    if (scrollTarget) {
                        scrollTarget.scrollIntoView({behavior: 'instant', block: 'start'});
                    }
                });
                return btn;
            };

            if (startPage > 1) paginationEl.appendChild(createBtn('<', startPage - 1));
            for (let i = startPage; i <= endPage; i++) paginationEl.appendChild(createBtn(i, i, i === currentPage));
            if (endPage < totalPages) {
                paginationEl.appendChild(createBtn('...', endPage + 1));
                paginationEl.appendChild(createBtn('>', endPage + 1));
            }
        };
        // ‚úÖ Ï∂îÏ≤ú ÎèÑÏÑú Î†åÎçîÎßÅ

        const renderRecommended = () => {
            const books = [
                {title: "Ïù¥ÌéôÌã∞Î∏å ÏûêÎ∞î", author: "Ï°∞ÏäàÏïÑ Î∏îÎ°úÌÅ¨", price: 35000},
                {title: "ÏûêÎ∞îÏùò Ï†ïÏÑù", author: "ÎÇ®Í∂ÅÏÑ±", price: 30000},
                {title: "Ïä§ÌîÑÎßÅ Î∂ÄÌä∏ ÏûÖÎ¨∏", author: "Ïù¥ÎèôÏö±", price: 32000},
                {title: "JPA ÏôÑÏ†Ñ Ï†ïÎ≥µ", author: "ÍπÄÏòÅÌïú", price: 38000},
                {title: "Í∞ùÏ≤¥ÏßÄÌñ•Ïùò ÏÇ¨Ïã§Í≥º Ïò§Ìï¥", author: "Ï°∞ÏòÅÌò∏", price: 28000}
            ];
            books.forEach(book => {
                const div = document.createElement('div');
                div.className = 'ink-card-white p-4 flex flex-col items-center text-center w-[200px]';
                div.innerHTML = `
        <div class="w-[120px] h-[180px] bg-gray-100 rounded-md overflow-hidden mb-3">
          <img src="https://image.aladin.co.kr/product/35259/73/coversum/k142934245_1.jpg" alt="${book.title}" class="w-full h-full object-cover" />
        </div>
        <h3 class="text-sm font-semibold text-gray-800 mb-1 truncate w-full">${book.title}</h3>
        <p class="text-xs text-gray-600 mb-1 truncate w-full">${book.author}</p>
        <div class="mb-3 flex flex-col items-center leading-tight">
          <span class="text-gray-400 line-through text-xs">‚Ç©${(book.price * 1.1).toLocaleString()}</span>
          <span class="text-sm text-gray-900 font-bold">‚Ç©${book.price.toLocaleString()}</span>
          <span class="bg-red-100 text-red-600 text-xs font-bold px-2 py-0.5 rounded-md mt-1">10%</span>
        </div>
      `;
                recommendedBooks.appendChild(div);
            });
        };

        // ÏàòÎüâ Ï°∞Ï†à

        window.changeQty = function (id, delta) {
            const qtyEl = document.getElementById(`qty-${id}`);
            let current = parseInt(qtyEl.value) || 1;
            const next = Math.max(1, current + delta);
            qtyEl.value = next;
        };
        // ÌëúÏãú Í∞úÏàò Î≥ÄÍ≤Ω

        itemsPerPageSelect.addEventListener('change', () => {
            currentPage = 1;
            itemsPerPage = parseInt(itemsPerPageSelect.value);
            fetchBooks();
        });

        const buildCategoryTree = (flatList) => {
            const map = {};
            const roots = [];

            flatList.forEach(cat => {
                cat.children = [];
                map[cat.id] = cat;
            });

            flatList.forEach(cat => {
                if (cat.parentId == null) {
                    roots.push(cat);
                } else if (map[cat.parentId]) {
                    map[cat.parentId].children.push(cat);
                }
            });

            return roots;
        };

        document.getElementById('sortSelect').addEventListener('change', (e) => {
            currentSort = e.target.value;
            currentPage = 1;
            fetchBooks();
        });


        const renderCategoryMenu = (categories, container) => {
            categories.forEach(cat => {
                const li = document.createElement('li');
                li.className = 'relative group w-max';
                li.innerHTML = `
                    <button type="button"
                        onclick="goToCategory('${cat.name}')"
                        class="text-left font-medium text-gray-700 hover:text-ink-primary transition-colors cursor-pointer whitespace-nowrap px-2 py-1 w-max">
                        ${cat.name}
                    </button>
                `;

                if (cat.children.length > 0) {
                    const subUl = document.createElement('ul');
                    subUl.className = `
                        absolute top-0 left-full
                        ml-2 z-50 px-1 py-1 rounded bg-white shadow-md
                        invisible opacity-0 pointer-events-none transition-opacity duration-200
                        min-w-max
                    `;
                    renderCategoryMenu(cat.children, subUl);
                    li.appendChild(subUl);
                }

                container.appendChild(li);
            });

            applyHoverDelay();
        };



        const applyHoverDelay = () => {
            document.querySelectorAll('#category-menu li.group').forEach(group => {
                const submenu = group.querySelector('ul');
                if (!submenu) return;

                let timeout;
                group.addEventListener('mouseenter', () => {
                    clearTimeout(timeout);
                    submenu.classList.remove('invisible', 'opacity-0', 'pointer-events-none');
                    submenu.classList.add('visible', 'opacity-100', 'pointer-events-auto');
                });

                group.addEventListener('mouseleave', () => {
                    timeout = setTimeout(() => {
                        submenu.classList.remove('visible', 'opacity-100', 'pointer-events-auto');
                        submenu.classList.add('invisible', 'opacity-0', 'pointer-events-none');
                    }, 100); // ÎîúÎ†àÏù¥Îäî ÌïÑÏöî Ïãú Ï°∞Ï†ï
                });
            });
        };

        // ‚úÖ Ïã§Ï†ú API Ìò∏Ï∂ú

        function fetchBooks() {
            fetch(`${window.api.gatewayBaseUrl}/shop/books?category=${encodeURIComponent(categoryName)}&page=${currentPage - 1}&size=${itemsPerPage}&sort=${currentSort}`)
                .then(response => response.json())
                .then(data => {
                    renderBooks(data.data.content);
                    renderPagination(data.data.totalElements);
                })
                .catch(err => console.error('ÎèÑÏÑú Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:', err));
        }

        function fetchReviewData(bookId) {
            const pageSize = 100; // Ìïú Î≤àÏóê Í∞ÄÏ†∏Ïò¨ ÏµúÎåÄ Î¶¨Î∑∞ Ïàò
            const baseUrl = `${window.api.gatewayBaseUrl}/shop/books/${bookId}/reviews`;

            async function fetchAllReviews(page = 0, collected = []) {
                const url = `${baseUrl}?page=${page}&size=${pageSize}`;
                const res = await fetch(url);
                const json = await res.json();

                const pageData = json.data || json; // data ÎûòÌïë Ïó¨Î∂Ä ÎåÄÏùë
                const content = pageData.content || [];
                const totalPages = pageData.totalPages;

                const all = collected.concat(content);

                if (page + 1 < totalPages) {
                    return fetchAllReviews(page + 1, all); // Îã§Ïùå ÌéòÏù¥ÏßÄ Ïû¨Í∑Ä Ìò∏Ï∂ú
                } else {
                    return all; // ÎßàÏßÄÎßâÍπåÏßÄ ÎèÑÎã¨ Ïãú Î∞òÌôò
                }
            }

            return fetchAllReviews().then(allReviews => {
                const total = allReviews.length;
                const avg = total > 0
                    ? (allReviews.reduce((sum, r) => sum + r.rating, 0) / total)
                    : 0;

                return {
                    average: avg,
                    count: total
                };
            }).catch(err => {
                console.error("üìõ Î¶¨Î∑∞ ÌÜµÍ≥Ñ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:", err);
                return { average: '-', count: 0 };
            });
        }
    });
    function checkNumeric(input) {
        input.value = input.value.replace(/[^0-9]/g, '');
        if (input.value === '' || parseInt(input.value) < 1) {
            input.value = 1;
        }
    }

    function addToCart(bookId, quantity) {
        const url = isLoggedIn ? `${contextPath}carts` : `${contextPath}guest-carts`;

        const form = document.createElement('form');
        form.method = 'post';
        form.action = url;

        const bookInput = document.createElement('input');
        bookInput.type = 'hidden';
        bookInput.name = 'bookId';
        bookInput.value = bookId;
        form.appendChild(bookInput);

        const qtyInput = document.createElement('input');
        qtyInput.type = 'hidden';
        qtyInput.name = 'quantity';
        qtyInput.value = quantity;
        form.appendChild(qtyInput);

        document.body.appendChild(form);
        form.submit();
    }
</script>
</body>
</html>