<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ink3</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/output.css(v=${#dates.createNow().getTime()})}">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .ink-input-group {
            @apply grid grid-cols-1 gap-2 mb-6;
        }

        .ink-input-group label {
            @apply text-gray-700 font-medium block mb-2;
        }

        .author-input-group {
            @apply flex items-center space-x-4 mb-3;
        }

        .category-select-group {
            @apply flex items-center space-x-4 mb-3;
        }
    </style>
    <script>
        $(document).ready(function() {
            $('.js-select').select2({
                allowClear: true
            });
        });
    </script>
</head>
<body class="bg-gray-100">
<div th:replace="~{admin/layout/fragments/header :: headerFragment}"></div>
<div class="flex flex-1 min-h-[calc(100vh-64px)]">
    <div th:replace="~{admin/layout/fragments/sidebar :: sidebarFragment}"></div>

    <main class="main-content-area flex-1 p-6 bg-gray-100 overflow-y-auto">
        <div class="bg-white w-3/5 px-10 py-12 rounded-md shadow-md max-w-3xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">도서 등록</h1>
            <form th:action="@{/admin/books}" method="post" enctype="multipart/form-data" class="space-y-8">

                <!-- 공통 스타일: label + input 그룹 -->
                <div class="grid grid-cols-1 gap-2">
                    <label for="isbn" class="text-gray-700 font-medium">ISBN</label>
                    <input type="text" id="isbn" name="isbn" required
                           class="ink-input-field w-full">
                </div>

                <div class="grid grid-cols-1 gap-2">
                    <label for="title" class="text-gray-700 font-medium">제목</label>
                    <input type="text" id="title" name="title" required
                           class="ink-input-field w-full">
                </div>

                <div class="grid grid-cols-1 gap-2">
                    <label for="contents" class="text-gray-700 font-medium">책 목차</label>
                    <textarea id="contents" name="contents" rows="5"
                              class="ink-input-field w-full"></textarea>
                </div>

                <div class="grid grid-cols-1 gap-2">
                    <label for="description" class="text-gray-700 font-medium">책 소개</label>
                    <textarea id="description" name="description" rows="5"
                              class="ink-input-field w-full"></textarea>
                </div>

                <div class="grid grid-cols-1 gap-2">
                    <label for="publishedAt" class="text-gray-700 font-medium">출간일</label>
                    <input type="date" id="publishedAt" name="publishedAt"
                           class="ink-input-field w-full">
                </div>

                <div class="grid grid-cols-1 gap-2">
                    <label for="originalPrice" class="text-gray-700 font-medium">정가 (원)</label>
                    <input type="number" id="originalPrice" name="originalPrice" required min="0"
                           class="ink-input-field w-full">
                </div>

                <div class="grid grid-cols-1 gap-2">
                    <label for="salePrice" class="text-gray-700 font-medium">판매가 (원)</label>
                    <input type="number" id="salePrice" name="salePrice" required min="0"
                           class="ink-input-field w-full">
                </div>

                <div class="grid grid-cols-1 gap-2">
                    <label for="quantity" class="text-gray-700 font-medium">수량 (개)</label>
                    <input type="number" id="quantity" name="quantity" required min="1"
                           class="ink-input-field w-full">
                </div>

                <div class="ink-input-group">
                    <label>카테고리</label>
                    <div id="categories-container">
                        <div class="category-select-group">
                            <select class="js-category-select category-level" data-level="1">
                                <option value="">1차 카테고리 선택</option>
                                <th:block th:each="topCategory : ${categories.content}">
                                    <option th:value="${topCategory.id}" th:text="${topCategory.name}"></option>
                                </th:block>
                            </select>
                            <select class="js-category-select category-level" data-level="2" disabled>
                                <option value="">2차 카테고리 선택</option>
                            </select>
                            <select class="js-category-select category-level" data-level="3" disabled>
                                <option value="">3차 카테고리 선택</option>
                            </select>
                            <input type="hidden" name="categoryIds">
                            <button type="button" onclick="addCategoryField()" class="ink-btn-primary">+</button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500">최상위 카테고리부터 하위 카테고리 순으로 선택하세요.</p>
                    <button type="button" onclick="addCategoryField()" class="ink-btn-primary mt-2">카테고리 추가</button>
                </div>

                <div class="ink-input-group">
                    <label>작가</label>
                    <div id="authors-container">
                        <div class="author-input-group">
                            <select name="authorIds" class="js-select w-1/3">
                                <option value="">작가 선택</option>
                                <th:block th:each="author : ${authors.content}">
                                    <option th:value="${author.id}" th:text="${author.name}"></option>
                                </th:block>
                            </select>
                            <input type="text" name="authorRoles" placeholder="역할 (지은이, 옮긴이 등)" class="ink-input-field w-1/3">
                            <button type="button" onclick="addAuthorField()" class="ink-btn-primary">+</button>
                        </div>
                    </div>
                    <button type="button" onclick="addAuthorField()" class="ink-btn-primary mt-2">작가 추가</button>
                </div>

                <div class="ink-input-group">
                    <label for="publisherId">출판사</label>
                    <select id="publisherId" name="publisherId" class="js-select w-full">
                        <option value="">출판사 선택</option>
                        <th:block th:each="publisher : ${publishers.content}">
                            <option th:value="${publisher.id}" th:text="${publisher.name}"></option>
                        </th:block>
                    </select>
                </div>

                <div class="ink-input-group">
                    <label for="tags">태그</label>
                    <select id="tags" name="tagIds" class="js-select w-full" multiple>
                        <option th:each="tag : ${tags.content}" th:value="${tag.id}" th:text="${tag.name}"></option>
                    </select>
                    <p class="text-sm text-gray-500">Ctrl 키를 누른 채로 선택하여 여러 태그를 선택할 수 있습니다.</p>
                </div>

                <div class="grid grid-cols-2 gap-2 items-center">
                    <label for="isPackable" class="text-gray-700 font-medium">포장 가능</label>
                    <input type="checkbox" id="isPackable" name="isPackable" class="w-5 h-5" style="accent-color: #86ef7d;">
                </div>

                <div class="ink-input-group">
                    <label for="coverImage">표지 이미지</label>
                    <input type="file" id="coverImage" name="coverImage" class="ink-input-field w-full">
                </div>

                <div class="flex justify-end">
                    <button type="submit" class="ink-btn-primary">등록</button>
                </div>

            </form>
        </div>
    </main>
</div>
<script th:inline="javascript">
    const contextPath = /*[[@{/}]]*/ '';

    function addAuthorField() {
        const container = document.getElementById('authors-container');
        const newAuthorGroup = document.createElement('div');
        newAuthorGroup.classList.add('author-input-group');
        newAuthorGroup.innerHTML = `
            <select name="authorIds" class="js-category-select w-1/2">
                <option value="">작가 선택</option>
                <th:block th:each="author : ${authors}">
                    <option th:value="${author.id}" th:text="${author.name}"></option>
                </th:block>
            </select>
            <input type="text" name="authorRoles" placeholder="역할 (지은이, 옮긴이 등)" class="ink-input-field w-1/3">
            <button type="button" onclick="removeAuthorField(this)" class="ink-btn-danger">-</button>
        `;
        container.appendChild(newAuthorGroup);
    }

    function removeAuthorField(button) {
        const authorGroup = button.parentNode;
        document.getElementById('authors-container').removeChild(authorGroup);
    }

    function addCategoryField() {
        const container = document.getElementById('categories-container');
        const newCategoryGroup = document.createElement('div');
        newCategoryGroup.classList.add('category-select-group');
        newCategoryGroup.innerHTML = `
            <select class="js-category-select category-level" data-level="1">
                <option value="">1차 카테고리 선택</option>
                <th:block th:each="topCategory : ${categories}">
                    <option th:value="${categories.id}" th:text="${categories.name}"></option>
                </th:block>
            </select>
            <select class="js-category-select category-level" data-level="2" disabled>
                <option value="">2차 카테고리 선택</option>
            </select>
            <select class="js-category-select category-level" data-level="3" disabled>
                <option value="">3차 카테고리 선택</option>
            </select>
            <input type="hidden" name="categoryIds">
            <button type="button" onclick="removeCategoryField(this)" class="ink-btn-danger">-</button>
        `;
        container.appendChild(newCategoryGroup);
        initializeCategoryDropdowns(); // 새로운 카테고리 그룹에 이벤트 리스너 다시 등록
    }

    function removeCategoryField(button) {
        const categoryGroup = button.parentNode;
        document.getElementById('categories-container').removeChild(categoryGroup);
    }

    function initializeCategoryDropdowns() {
        document.querySelectorAll('.category-level').forEach(select => {
            select.addEventListener('change', async (event) => {
                const selectedCategoryId = event.target.value;
                const level = parseInt(event.target.dataset.level);
                const nextLevel = level + 1;
                const nextSelect = event.target.parentNode.querySelector(`select[data-level="${nextLevel}"]`);

                // 다음 레벨 드롭다운 초기화 및 활성화
                if (nextSelect) {
                    nextSelect.innerHTML = '<option value="">선택하세요</option>';
                    nextSelect.disabled = true;

                    if (selectedCategoryId) {
                        try {
                            const response = await fetch(`/api/categories/${selectedCategoryId}/children`);
                            if (response.ok) {
                                const children = await response.json();
                                children.forEach(child => {
                                    const option = document.createElement('option');
                                    option.value = child.id;
                                    option.textContent = child.name;
                                    nextSelect.appendChild(option);
                                });
                                nextSelect.disabled = false;
                            } else {
                                console.error('하위 카테고리 로딩 실패');
                            }
                        } catch (error) {
                            console.error('하위 카테고리 로딩 중 오류:', error);
                        }
                    }
                }

                // 선택된 전체 카테고리 ID 업데이트 (히든 필드)
                updateSelectedCategories(event.target.parentNode);
            });
        });
    }

    function updateSelectedCategories(categoryGroup) {
        const selects = categoryGroup.querySelectorAll('.category-level');
        let selectedIds = [];
        selects.forEach(select => {
            if (select.value) {
                selectedIds.push(select.value);
            }
        });
        categoryGroup.querySelector('input[name="categoryIds"]').value = selectedIds.join(',');
    }

    document.addEventListener('DOMContentLoaded', () => {
        initializeCategoryDropdowns();
    });
</script>
</body>
</html>
